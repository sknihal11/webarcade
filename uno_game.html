<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>UNO Royale – WebArcade</title>
<style>
  :root {
    --red: #ff5555; --blue: #5555ff; --green: #55aa55; --yellow: #ffaa00;
    --bg: #0f172a; --accent: #6366f1;
  }
  * { box-sizing: border-box; font-family: 'Segoe UI', Roboto, sans-serif; user-select: none; }
  
  body { 
    margin: 0; background: var(--bg); color: white; 
    height: 100vh; overflow: hidden; display: flex; flex-direction: column;
  }

  /* --- THE TABLE --- */
  .arena {
    flex: 1; position: relative;
    background: radial-gradient(circle at center, #1e293b 0%, #020617 100%);
    perspective: 1000px;
    display: flex; align-items: center; justify-content: center;
  }

  /* --- REVERSE ANIMATION OVERLAY --- */
  .direction-ring {
    position: absolute; width: 280px; height: 280px;
    border: 8px dashed rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    transition: transform 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    display: flex; align-items: center; justify-content: center;
  }
  .direction-ring::after {
    content: '➔'; position: absolute; top: -20px; font-size: 30px; color: rgba(255,255,255,0.3);
  }
  .rev-clockwise { transform: rotate(360deg); }
  .rev-counter { transform: rotate(-360deg) scaleX(-1); }

  /* --- PLAYERS --- */
  .player-box {
    position: absolute; display: flex; flex-direction: column; align-items: center;
    transition: all 0.3s; padding: 10px; border-radius: 15px;
  }
  .active-turn { 
    background: rgba(99, 102, 241, 0.2); 
    box-shadow: 0 0 20px var(--accent);
    transform: scale(1.1);
  }

  .p-bottom { bottom: 20px; width: 100%; }
  .p-top { top: 20px; transform: rotate(180deg); }
  .p-left { left: 10px; transform: rotate(90deg); }
  .p-right { right: 10px; transform: rotate(-90deg); }

  .avatar {
    width: 50px; height: 50px; border-radius: 50%; border: 3px solid #fff;
    background: #334155; margin-bottom: 5px;
  }

  /* --- CARDS --- */
  .card {
    width: 70px; height: 100px; border-radius: 10px; border: 4px solid #fff;
    display: flex; align-items: center; justify-content: center;
    font-weight: 900; font-size: 24px; cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    transition: transform 0.3s ease, margin 0.3s;
    background-color: #222; position: relative;
  }
  .my-cards .card { margin-left: -25px; }
  .my-cards .card:first-child { margin-left: 0; }
  .my-cards .card:hover { transform: translateY(-30px) rotate(5deg); z-index: 100; }

  .c-red { background: var(--red); }
  .c-blue { background: var(--blue); }
  .c-green { background: var(--green); }
  .c-yellow { background: var(--yellow); }
  .c-wild { background: linear-gradient(45deg, var(--red), var(--blue), var(--green), var(--yellow)); }

  /* --- PILES --- */
  .center-piles { display: flex; gap: 30px; z-index: 10; }
  .draw-pile { 
    width: 80px; height: 115px; background: #111; border: 3px solid #444; 
    border-radius: 12px; display: flex; align-items: center; justify-content: center;
    cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.4);
  }
  
  /* Play Animation */
  @keyframes throwCard {
    0% { transform: translateY(200px) scale(0.5) rotate(45deg); opacity: 0; }
    100% { transform: translateY(0) scale(1) rotate(0deg); opacity: 1; }
  }
  .last-played { animation: throwCard 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28); }

  /* Color Picker */
  #colorModal {
    position: fixed; inset: 0; background: rgba(0,0,0,0.85);
    display: none; place-items: center; z-index: 1000;
  }
  .color-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .color-btn { width: 100px; height: 100px; border-radius: 20px; border: 5px solid white; cursor: pointer; }
</style>
</head>
<body>

<div class="arena">
  <div id="dirRing" class="direction-ring rev-clockwise"></div>

  <div id="playerTop" class="player-box p-top"><div class="avatar"></div><span class="count">7</span></div>
  <div id="playerLeft" class="player-box p-left"><div class="avatar"></div><span class="count">7</span></div>
  <div id="playerRight" class="player-box p-right"><div class="avatar"></div><span class="count">7</span></div>

  <div class="center-piles">
    <div class="draw-pile" onclick="drawCard()">
      <div style="font-weight:bold; color:#666">DRAW</div>
    </div>
    <div id="discardArea"></div>
  </div>

  <div class="player-box p-bottom">
    <div id="myHand" class="my-cards" style="display:flex;"></div>
    <p id="turnStatus" style="margin-top:15px; font-weight:bold; letter-spacing:1px;"></p>
  </div>
</div>

<div id="colorModal">
  <div class="color-grid">
    <div class="color-btn c-red" onclick="pickColor('red')"></div>
    <div class="color-btn c-blue" onclick="pickColor('blue')"></div>
    <div class="color-btn c-green" onclick="pickColor('green')"></div>
    <div class="color-btn c-yellow" onclick="pickColor('yellow')"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getFirestore, doc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyCzomf89xZhgcPsfYXKsYspCt-CiUVzjBA",
  authDomain: "webarcade-d4c3d.firebaseapp.com",
  projectId: "webarcade-d4c3d"
});
const auth = getAuth(app);
const db = getFirestore(app);

const params = new URLSearchParams(window.location.search);
const roomId = params.get("room");
let userUid, game, wildIdx;

onAuthStateChanged(auth, u => {
  if(!u) return; userUid = u.uid;
  onSnapshot(doc(db, "matches", roomId), snap => {
    game = snap.data();
    render();
  });
});

function render() {
  const players = game.players;
  const myIdx = players.indexOf(userUid);
  const isMyTurn = players[game.turnIndex] === userUid;

  // 1. Reverse Ring Animation
  const ring = document.getElementById("dirRing");
  ring.className = `direction-ring ${game.direction === 1 ? 'rev-clockwise' : 'rev-counter'}`;

  // 2. Center Card
  const disc = document.getElementById("discardArea");
  disc.innerHTML = `<div class="card c-${game.currentCard.color} last-played">${game.currentCard.val}</div>`;

  // 3. Status
  document.getElementById("turnStatus").innerText = isMyTurn ? "★ YOUR TURN ★" : "WAITING FOR OTHERS...";

  // 4. My Hand
  const myHand = document.getElementById("myHand");
  myHand.innerHTML = "";
  (game.hands[userUid] || []).forEach((c, i) => {
    const el = document.createElement("div");
    el.className = `card c-${c.color}`;
    el.innerText = c.val;
    el.onclick = () => playCard(i);
    myHand.appendChild(el);
  });

  // 5. Opponents (Dynamic Layout)
  const posElements = [
    { id: 'playerLeft', idx: (myIdx + 1) % players.length },
    { id: 'playerTop', idx: (myIdx + 2) % players.length },
    { id: 'playerRight', idx: (myIdx + 3) % players.length }
  ];

  posElements.forEach(pos => {
    const el = document.getElementById(pos.id);
    if (players.length > 1 && players[pos.idx] && players[pos.idx] !== userUid) {
      el.style.display = "flex";
      const count = game.hands[players[pos.idx]].length;
      el.querySelector(".count").innerText = count + " Cards";
      if (game.turnIndex === pos.idx) el.classList.add("active-turn");
      else el.classList.remove("active-turn");
    } else {
      el.style.display = "none";
    }
  });
}

window.playCard = async (i) => {
  if (game.players[game.turnIndex] !== userUid) return;
  const card = game.hands[userUid][i];
  const top = game.currentCard;

  if (card.color !== 'wild' && card.color !== top.color && card.val !== top.val) return;

  if (card.color === 'wild') {
    wildIdx = i;
    document.getElementById("colorModal").style.display = "grid";
    return;
  }
  executeMove(i, card.color);
};

window.pickColor = (c) => {
  document.getElementById("colorModal").style.display = "none";
  executeMove(wildIdx, c);
};

async function executeMove(idx, color) {
  let hands = game.hands;
  let card = hands[userUid].splice(idx, 1)[0];
  if (card.color === 'wild') card.color = color;

  let direction = game.direction;
  if (card.val === 'REV') direction *= -1;

  let nextIdx = (game.turnIndex + direction + game.players.length) % game.players.length;

  // Power Logic
  if (card.val === 'SKIP') {
    nextIdx = (nextIdx + direction + game.players.length) % game.players.length;
  } else if (card.val === '+2' || card.val === '+4') {
    const victim = game.players[nextIdx];
    const penalty = game.deck.splice(0, card.val === '+2' ? 2 : 4);
    hands[victim].push(...penalty);
    nextIdx = (nextIdx + direction + game.players.length) % game.players.length;
  }

  await updateDoc(doc(db, "matches", roomId), {
    hands, currentCard: card, turnIndex: nextIdx, direction, deck: game.deck
  });
}

window.drawCard = async () => {
  if (game.players[game.turnIndex] !== userUid) return;
  const hands = game.hands;
  hands[userUid].push(game.deck.shift());
  const nextIdx = (game.turnIndex + game.direction + game.players.length) % game.players.length;
  await updateDoc(doc(db, "matches", roomId), { hands, turnIndex: nextIdx, deck: game.deck });
};
</script>
</body>
</html>

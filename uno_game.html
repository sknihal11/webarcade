<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UNO Royale Pro | WebArcade</title>
    <style>
        :root { 
            --red: #ff4757; --blue: #2e86de; --green: #2ed573; --yellow: #ffa502; 
            --bg: #0f172a; --accent: #6366f1;
        }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; user-select: none; touch-action: manipulation; }
        
        body { 
            margin: 0; background: var(--bg); color: white; height: 100vh; overflow: hidden;
            background: radial-gradient(circle at center, #1e293b 0%, #020617 100%);
        }

        /* --- THE STAGE --- */
        .arena { position: relative; height: 100vh; width: 100vw; display: flex; align-items: center; justify-content: center; }

        /* --- REVERSE RING --- */
        #revRing {
            position: absolute; width: 280px; height: 280px; border: 6px dashed rgba(255,255,255,0.1);
            border-radius: 50%; transition: 1s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        .cw { transform: rotate(360deg); }
        .ccw { transform: rotate(-360deg) scaleX(-1); }

        /* --- CARDS --- */
        .card {
            width: 65px; height: 95px; border-radius: 10px; border: 3px solid #fff;
            display: inline-flex; align-items: center; justify-content: center;
            font-weight: 900; font-size: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.4);
            transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); cursor: pointer;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        .playable { transform: translateY(-20px); z-index: 100 !important; box-shadow: 0 0 20px #fff; }
        .dimmed { opacity: 0.4; filter: grayscale(0.5); pointer-events: none; }

        /* --- PLAYER SLOTS --- */
        .player { position: absolute; display: flex; flex-direction: column; align-items: center; z-index: 10; transition: 0.5s; }
        .avatar { 
            width: 50px; height: 50px; border-radius: 50%; border: 3px solid #fff; 
            background: #334155; overflow: hidden; margin-bottom: 5px; 
        }
        .active-turn .avatar { border-color: var(--accent); box-shadow: 0 0 20px var(--accent); transform: scale(1.2); }

        .p-0 { bottom: 25px; left: 50%; transform: translateX(-50%); width: 100%; }
        .p-1 { left: 20px; top: 50%; transform: translateY(-50%) rotate(90deg); }
        .p-2 { top: 25px; left: 50%; transform: translateX(-50%) rotate(180deg); }
        .p-3 { right: 20px; top: 50%; transform: translateY(-50%) rotate(-90deg); }

        /* --- CENTER PILE --- */
        .center-pile { display: flex; gap: 20px; z-index: 5; }
        #stackCounter {
            position: absolute; top: -45px; left: 50%; transform: translateX(-50%);
            background: #ffd700; color: #000; padding: 4px 12px; border-radius: 20px;
            font-weight: bold; font-size: 14px; display: none; animation: bounce 1s infinite;
        }

        /* --- UI ELEMENTS --- */
        #leaveBtn { position: fixed; top: 20px; left: 20px; background: rgba(255,0,0,0.2); border: 1px solid white; color: white; padding: 8px 15px; border-radius: 10px; cursor: pointer; z-index: 1000; }
        #unoBtn { position: fixed; bottom: 160px; right: 20px; width: 70px; height: 70px; border-radius: 50%; background: red; color: white; font-weight: bold; border: 4px solid white; display: none; align-items: center; justify-content: center; z-index: 1000; box-shadow: 0 0 20px rgba(255,0,0,0.5); }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; }
        
        /* --- CHAT --- */
        #chatBox { position: fixed; right: 20px; bottom: 20px; width: 250px; height: 150px; background: rgba(0,0,0,0.5); border-radius: 10px; display: flex; flex-direction: column; z-index: 500; pointer-events: none; }
        .chat-msg { font-size: 12px; padding: 2px 10px; }

        @keyframes bounce { 0%, 100% { transform: translateX(-50%) translateY(0); } 50% { transform: translateX(-50%) translateY(-50%); } }
        @keyframes fly { from { transform: translate(var(--sx), var(--sy)); } to { transform: translate(0, 0); } }
        .flying-card { position: fixed; z-index: 1000; animation: fly 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    </style>
</head>
<body>

<div class="arena">
    <button id="leaveBtn" onclick="confirmLeave()">ðŸšª Quit</button>
    <div id="revRing"></div>

    <div class="player p-1" id="slot-1"><div class="avatar" id="av-1"></div><div id="hand-1"></div></div>
    <div class="player p-2" id="slot-2"><div class="avatar" id="av-2"></div><div id="hand-2"></div></div>
    <div class="player p-3" id="slot-3"><div class="avatar" id="av-3"></div><div id="hand-3"></div></div>

    <div class="center-pile">
        <div id="stackCounter">DRAW +4</div>
        <div class="card" style="background:#222; border-style:dashed" onclick="drawCard()">UNO</div>
        <div id="discardPile"></div>
    </div>

    <div class="player p-0" id="slot-0">
        <div id="hand-0" style="display:flex; justify-content:center;"></div>
    </div>
</div>

<div id="unoBtn" onclick="shoutUno()">UNO!</div>

<div id="colorPicker" class="overlay">
    <h2 style="margin-bottom:20px">Pick Color</h2>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
        <div class="card" style="background:var(--red)" onclick="pickColor('red')"></div>
        <div class="card" style="background:var(--blue)" onclick="pickColor('blue')"></div>
        <div class="card" style="background:var(--green)" onclick="pickColor('green')"></div>
        <div class="card" style="background:var(--yellow)" onclick="pickColor('yellow')"></div>
    </div>
</div>

<div id="swapPicker" class="overlay">
    <h2>Swap Hands With?</h2>
    <div id="swapOptions" style="display:grid; gap:10px; margin-top:20px"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getFirestore, doc, onSnapshot, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig = { apiKey: "AIzaSyCzomf89xZhgcPsfYXKsYspCt-CiUVzjBA", authDomain: "webarcade-d4c3d.firebaseapp.com", projectId: "webarcade-d4c3d" };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const room = new URLSearchParams(window.location.search).get("room");

let userUid, game, pendingIdx, hasShouted = false;

onAuthStateChanged(auth, u => { if(u){ userUid = u.uid; subscribe(); } });

function subscribe() {
    onSnapshot(doc(db, "matches", room), snap => {
        game = snap.data();
        if(!game) return;
        if(game.status === 'ended') { alert("Game Over!"); location.href="blog.html"; }
        render();
    });
}

function render() {
    const players = game.players;
    const myIdx = players.indexOf(userUid);
    const isMyTurn = game.turnIndex === myIdx;

    // Table UI
    document.getElementById("revRing").className = game.direction === 1 ? 'cw' : 'ccw';
    document.getElementById("discardPile").innerHTML = `<div class="card" style="background:var(--${game.currentCard.color})">${game.currentCard.val}</div>`;
    
    const stackUI = document.getElementById("stackCounter");
    if(game.stack > 0) { stackUI.innerText = `STACK +${game.stack}`; stackUI.style.display="block"; }
    else stackUI.style.display="none";

    // Player Hands
    players.forEach((uid, i) => {
        const rel = (i - myIdx + players.length) % players.length;
        const slot = document.getElementById(`slot-${rel}`);
        if(game.turnIndex === i) slot.classList.add("active-turn"); else slot.classList.remove("active-turn");

        const handDiv = document.getElementById(`hand-${rel}`);
        if(rel === 0) {
            handDiv.innerHTML = "";
            game.hands[uid].forEach((c, idx) => {
                const el = document.createElement("div");
                const canPlay = isValid(c);
                el.className = `card ${canPlay ? 'playable' : 'dimmed'}`;
                el.style.backgroundColor = `var(--${c.color})`;
                el.style.marginLeft = "-30px";
                el.innerText = c.val;
                el.onclick = () => playCard(idx);
                handDiv.appendChild(el);
            });
            document.getElementById("unoBtn").style.display = (game.hands[uid].length === 2 && isMyTurn) ? "flex" : "none";
        } else {
            handDiv.innerHTML = `<div class="card" style="background:#222">ðŸŽ´ ${game.hands[uid].length}</div>`;
        }
    });
}

function isValid(card) {
    const top = game.currentCard;
    if(game.stack > 0) {
        if(top.val === '+2' && card.val === '+2') return true;
        if(top.val === '+4' && card.val === '+4') return true;
        return false;
    }
    return (card.color === 'wild' || card.color === top.color || card.val === top.val);
}

window.playCard = (idx) => {
    const players = game.players;
    const card = game.hands[userUid][idx];
    const isMyTurn = players[game.turnIndex] === userUid;
    
    // Jump-in Logic (Exact match)
    const isJumpIn = (card.val === game.currentCard.val && card.color === game.currentCard.color);
    if(!isMyTurn && !isJumpIn) return;
    if(isMyTurn && !isValid(card)) return;

    if(card.color === 'wild') { pendingIdx = idx; document.getElementById("colorPicker").style.display="flex"; return; }
    if(card.val === '7' && isMyTurn) { pendingIdx = idx; showSwapPicker(); return; }
    executeMove(idx, card.color);
};

window.pickColor = (c) => { document.getElementById("colorPicker").style.display="none"; executeMove(pendingIdx, c); };

async function executeMove(idx, color, swapUid = null) {
    let hands = game.hands;
    let card = hands[userUid].splice(idx, 1)[0];
    if(card.color === 'wild') card.color = color;

    // Penalty check
    if(hands[userUid].length === 1 && !hasShouted) {
        hands[userUid].push(...game.deck.splice(0, 2));
        alert("PENALTY! No UNO shouted.");
    }
    hasShouted = false;

    let stack = game.stack || 0;
    if(card.val === '+2') stack += 2;
    if(card.val === '+4') stack += 4;

    let dir = game.direction;
    if(card.val === 'REV') dir *= -1;

    let next = (game.turnIndex + dir + game.players.length) % game.players.length;
    if(card.val === 'SKIP') next = (next + dir + game.players.length) % game.players.length;

    // 0 Rule: Pass Hands
    if(card.val === '0') {
        let newHands = {};
        game.players.forEach((uid, i) => {
            let target = (i + dir + game.players.length) % game.players.length;
            newHands[game.players[target]] = hands[uid];
        });
        hands = newHands;
    }

    // 7 Rule: Swap
    if(swapUid) {
        let temp = hands[userUid];
        hands[userUid] = hands[swapUid];
        hands[swapUid] = temp;
    }

    await updateDoc(doc(db, "matches", room), {
        hands, currentCard: card, turnIndex: next, direction: dir, stack, deck: game.deck
    });
}

window.drawCard = async () => {
    if(game.players[game.turnIndex] !== userUid) return;
    let hands = game.hands;
    let amt = game.stack > 0 ? game.stack : 1;
    hands[userUid].push(...game.deck.splice(0, amt));
    
    let next = (game.turnIndex + game.direction + game.players.length) % game.players.length;
    await updateDoc(doc(db, "matches", room), { hands, stack: 0, turnIndex: next, deck: game.deck });
};

window.shoutUno = () => { 
    hasShouted = true; 
    document.getElementById("unoBtn").style.background = "#2ed573"; 
    setTimeout(() => document.getElementById("unoBtn").style.background = "red", 1000);
};

function showSwapPicker() {
    const div = document.getElementById("swapOptions"); div.innerHTML = "";
    game.players.forEach(uid => {
        if(uid !== userUid) {
            const b = document.createElement("button"); b.innerText = "Swap with Player " + uid.substring(0,4);
            b.style.padding = "10px";
            b.onclick = () => { document.getElementById("swapPicker").style.display="none"; executeMove(pendingIdx, game.hands[userUid][pendingIdx].color, uid); };
            div.appendChild(b);
        }
    });
    document.getElementById("swapPicker").style.display = "flex";
}

window.confirmLeave = async () => {
    if(!confirm("Leave match? Your cards will return to the deck.")) return;
    const players = game.players.filter(u => u !== userUid);
    if(players.length < 1) await deleteDoc(doc(db, "matches", room));
    else {
        let hands = game.hands;
        game.deck.push(...hands[userUid]);
        delete hands[userUid];
        await updateDoc(doc(db, "matches", room), { players, hands, turnIndex: 0, deck: game.deck });
    }
    location.href = "blog.html";
};
</script>
</body>
</html>

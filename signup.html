<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sign Up â€“ WebArcade</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        body {
            margin: 0;
            min-height: 100vh;
            font-family: "Segoe UI", sans-serif;
            background: radial-gradient(circle at top, #1e293b, #020617);
            display: flex;
            justify-content: center;
            align-items: center;
            color: #e5e7eb;
        }

        .card {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(20px);
            border-radius: 18px;
            padding: 32px;
            width: 100%;
            max-width: 380px;
            box-shadow: 0 25px 60px rgba(0,0,0,.4);
            animation: fade 0.8s ease;
        }

        h1 { text-align: center; margin-bottom: 8px; }
        p { text-align: center; opacity: 0.85; font-size: 14px; margin-bottom: 24px; }

        input {
            width: 100%;
            padding: 14px;
            margin-bottom: 14px;
            border-radius: 10px;
            border: 2px solid transparent;
            outline: none;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 15px;
            transition: border-color 0.3s;
        }

        input::placeholder { color: #cbd5f5; }
        input.valid { border-color: #22c55e; }
        input.invalid { border-color: #ef4444; }

        .error-msg {
            color: #ef4444;
            font-size: 12px;
            margin-top: -10px;
            margin-bottom: 10px;
            padding-left: 5px;
            display: none;
        }

        .error-msg.show { display: block; }

        button {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, #6366f1, #818cf8);
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform .2s, box-shadow .2s;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(99,102,241,.5);
        }

        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .link { text-align: center; margin-top: 16px; font-size: 14px; }
        .link a { color: #818cf8; text-decoration: none; font-weight: bold; }

        @keyframes fade {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: none; }
        }

        .loading { pointer-events: none; opacity: 0.7; }
    </style>
</head>
<body>

<div class="card">
    <h1>WebArcade ðŸŽ®</h1>
    <p>Create your account</p>

    <input id="username" type="text" placeholder="Username (3-20 chars)" maxlength="20" />
    <div class="error-msg" id="usernameError"></div>

    <input id="email" type="email" placeholder="Real Email Address" />
    <div class="error-msg" id="emailError"></div>

    <input id="password" type="password" placeholder="Password (Min 8 chars, 1 Cap, 1 Num)" />
    <div class="error-msg" id="passwordError"></div>

    <button id="signupBtn" onclick="signupUser()">Sign Up</button>

    <div class="link">
        Already have an account? <a href="login.html">Login</a>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCzomf89xZhgcPsfYXKsYspCt-CiUVzjBA",
        authDomain: "webarcade-d4c3d.firebaseapp.com",
        projectId: "webarcade-d4c3d",
        storageBucket: "webarcade-d4c3d.firebasestorage.app",
        messagingSenderId: "918209461327",
        appId: "1:918209461327:web:bd9c1a2431f9b5c66ffe3a"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- ENHANCED VALIDATION ---
    function validateUsername(u) {
        if (!u || u.length < 3) return "Min 3 characters required";
        if (!/^[a-zA-Z0-9_]+$/.test(u)) return "Letters, numbers, and underscores only";
        return null;
    }

    function validateEmail(e) {
        const pattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return pattern.test(e) ? null : "Enter a valid email address";
    }

    // Fixed password logic to satisfy browser security checks
    function validatePassword(p) {
        if (p.length < 8) return "Min 8 characters required";
        if (!/[A-Z]/.test(p)) return "Must include at least one uppercase letter";
        if (!/[0-9]/.test(p)) return "Must include at least one number";
        return null;
    }

    const inputs = {
        username: document.getElementById("username"),
        email: document.getElementById("email"),
        password: document.getElementById("password")
    };
    const errDivs = {
        username: document.getElementById("usernameError"),
        email: document.getElementById("emailError"),
        password: document.getElementById("passwordError")
    };

    function showUIError(field, msg) {
        inputs[field].classList.add("invalid");
        inputs[field].classList.remove("valid");
        errDivs[field].textContent = msg;
        errDivs[field].classList.add("show");
    }

    function clearUIError(field) {
        inputs[field].classList.remove("invalid");
        inputs[field].classList.add("valid");
        errDivs[field].classList.remove("show");
    }

    // --- CORE SIGNUP LOGIC ---
    window.signupUser = async function () {
        const username = inputs.username.value.trim();
        const email = inputs.email.value.trim();
        const password = inputs.password.value;

        // Run validations
        const uErr = validateUsername(username);
        const eErr = validateEmail(email);
        const pErr = validatePassword(password);

        if (uErr) return showUIError("username", uErr);
        if (eErr) return showUIError("email", eErr);
        if (pErr) return showUIError("password", pErr);

        const btn = document.getElementById("signupBtn");
        btn.disabled = true;
        btn.textContent = "Setting up account...";
        document.querySelector(".card").classList.add("loading");

        try {
            // 1. Create Auth User
            const cred = await createUserWithEmailAndPassword(auth, email, password);
            
            // 2. Generate a unique Session ID for this device
            const sessionId = crypto.randomUUID();
            localStorage.setItem("active_arcade_session", sessionId);

            // 3. Update Auth Profile
            await updateProfile(cred.user, { displayName: username });

            // 4. Create Firestore document with Session Lock
            await setDoc(doc(db, "users", cred.user.uid), {
                username: username,
                usernameLower: username.toLowerCase(),
                email: email,
                activeSessionId: sessionId, // This is the key to preventing multi-device play
                createdAt: new Date(),
                stats: { wins: 0, losses: 0 }
            });

            alert("Welcome to WebArcade! ðŸŽ‰");
            window.location.href = "index.html";

        } catch (error) {
            btn.disabled = false;
            btn.textContent = "Sign Up";
            document.querySelector(".card").classList.remove("loading");
            
            if (error.code === "auth/email-already-in-use") {
                showUIError("email", "Email already registered");
            } else {
                alert(error.message);
            }
        }
    };

    // Real-time UI feedback
    Object.keys(inputs).forEach(key => {
        inputs[key].addEventListener("input", () => clearUIError(key));
    });

</script>
</body>
</html>

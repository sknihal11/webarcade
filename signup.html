<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Sign Up ‚Äì WebArcade</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  body {
    margin: 0;
    min-height: 100vh;
    font-family: "Segoe UI", sans-serif;
    background: radial-gradient(circle at top, #1e293b, #020617);
    display: flex;
    justify-content: center;
    align-items: center;
    color: #e5e7eb;
  }

  .card {
    background: rgba(255,255,255,0.05);
    backdrop-filter: blur(20px);
    border-radius: 18px;
    padding: 32px;
    width: 100%;
    max-width: 380px;
    box-shadow: 0 25px 60px rgba(0,0,0,.4);
    animation: fade 0.8s ease;
  }

  h1 {
    text-align: center;
    margin-bottom: 8px;
  }

  p {
    text-align: center;
    opacity: 0.85;
    font-size: 14px;
    margin-bottom: 24px;
  }

  input {
    width: 100%;
    padding: 14px;
    margin-bottom: 14px;
    border-radius: 10px;
    border: 2px solid transparent;
    outline: none;
    background: rgba(255,255,255,0.1);
    color: white;
    font-size: 15px;
    transition: border-color 0.3s;
  }

  input::placeholder {
    color: #cbd5f5;
  }

  input.valid {
    border-color: #22c55e;
  }

  input.invalid {
    border-color: #ef4444;
  }

  input.warning {
    border-color: #f59e0b;
  }

  .error-msg {
    color: #ef4444;
    font-size: 12px;
    margin-top: -10px;
    margin-bottom: 10px;
    padding-left: 5px;
    display: none;
  }

  .error-msg.show {
    display: block;
  }

  .warning-msg {
    color: #f59e0b;
    font-size: 12px;
    margin-top: -10px;
    margin-bottom: 10px;
    padding-left: 5px;
    display: none;
  }

  .warning-msg.show {
    display: block;
  }

  .password-strength {
    height: 4px;
    border-radius: 2px;
    margin-top: -10px;
    margin-bottom: 10px;
    background: rgba(255,255,255,0.1);
    overflow: hidden;
  }

  .password-strength-bar {
    height: 100%;
    width: 0%;
    transition: width 0.3s, background 0.3s;
  }

  .password-strength-bar.weak {
    width: 33%;
    background: #ef4444;
  }

  .password-strength-bar.medium {
    width: 66%;
    background: #f59e0b;
  }

  .password-strength-bar.strong {
    width: 100%;
    background: #22c55e;
  }

  button {
    width: 100%;
    padding: 14px;
    border: none;
    border-radius: 12px;
    background: linear-gradient(135deg, #6366f1, #818cf8);
    color: white;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: transform .2s, box-shadow .2s;
  }

  button:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(99,102,241,.5);
  }

  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .link {
    text-align: center;
    margin-top: 16px;
    font-size: 14px;
  }

  .link a {
    color: #818cf8;
    text-decoration: none;
    font-weight: bold;
  }

  @keyframes fade {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: none; }
  }

  .loading {
    pointer-events: none;
    opacity: 0.7;
  }

  .info-text {
    font-size: 11px;
    color: #94a3b8;
    margin-top: -8px;
    margin-bottom: 12px;
    padding-left: 5px;
  }
</style>
</head>

<body>

<div class="card">
  <h1>WebArcade üéÆ</h1>
  <p>Create your account</p>

  <input id="username" type="text" placeholder="Username (3-20 chars, alphanumeric)" maxlength="20" autocomplete="username" />
  <div class="error-msg" id="usernameError"></div>

  <input id="email" type="email" placeholder="Email (must be real)" autocomplete="email" />
  <div class="error-msg" id="emailError"></div>

  <input id="password" type="password" placeholder="Password (min 8 chars, mix letters & numbers)" autocomplete="new-password" />
  <div class="password-strength">
    <div class="password-strength-bar" id="strengthBar"></div>
  </div>
  <div class="error-msg" id="passwordError"></div>
  <div class="warning-msg" id="passwordWarning"></div>
  <div class="info-text">We check passwords against known breaches for your security</div>

  <button id="signupBtn" onclick="signupUser()">Sign Up</button>

  <div class="link">
    Already have an account?
    <a href="login.html">Login</a>
  </div>
</div>

<!-- FIREBASE -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import {
    getAuth,
    createUserWithEmailAndPassword,
    updateProfile
  } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
  import {
    getFirestore,
    doc,
    setDoc,
    collection,
    query,
    where,
    getDocs
  } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCzomf89xZhgcPsfYXKsYspCt-CiUVzjBA",
    authDomain: "webarcade-d4c3d.firebaseapp.com",
    projectId: "webarcade-d4c3d",
    storageBucket: "webarcade-d4c3d.firebasestorage.app",
    messagingSenderId: "918209461327",
    appId: "1:918209461327:web:bd9c1a2431f9b5c66ffe3a"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // --- SECURITY: GENERATE DEVICE ID ---
  function getDeviceId() {
    let deviceId = localStorage.getItem('deviceId');
    if (!deviceId) {
      deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substring(2, 15);
      localStorage.setItem('deviceId', deviceId);
    }
    return deviceId;
  }

  // --- PASSWORD BREACH CHECK (Have I Been Pwned API) ---
  async function checkPasswordBreach(password) {
    try {
      // Use SHA-1 hash (required by HIBP API)
      const encoder = new TextEncoder();
      const data = encoder.encode(password);
      const hashBuffer = await crypto.subtle.digest('SHA-1', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('').toUpperCase();
      
      // HIBP k-Anonymity: send first 5 chars, get back matching suffixes
      const prefix = hashHex.substring(0, 5);
      const suffix = hashHex.substring(5);
      
      const response = await fetch(`https://api.pwnedpasswords.com/range/${prefix}`);
      const text = await response.text();
      
      // Check if our suffix appears in the results
      const lines = text.split('\n');
      for (let line of lines) {
        const [hashSuffix, count] = line.split(':');
        if (hashSuffix === suffix) {
          return parseInt(count); // Return how many times it's been breached
        }
      }
      
      return 0; // Not breached
    } catch (error) {
      console.error("Breach check failed:", error);
      return 0; // Allow signup on error (don't block due to network issues)
    }
  }

  // --- VALIDATION HELPERS ---
  
  function validateUsername(username) {
    if (!username || username.length < 3) {
      return "Username must be at least 3 characters";
    }
    if (username.length > 20) {
      return "Username must be less than 20 characters";
    }
    if (!/^[a-zA-Z0-9_]+$/.test(username)) {
      return "Username can only contain letters, numbers, and underscores";
    }
    return null;
  }

  function validateEmail(email) {
    if (!email) {
      return "Email is required";
    }
    
    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailPattern.test(email)) {
      return "Please enter a valid email address";
    }
    
    const blockedDomains = [
      'test.com', 'fake.com', 'example.com', 'mail.com',
      'tempmail.com', '10minutemail.com', 'guerrillamail.com',
      'mailinator.com', 'throwaway.email', 'temp-mail.org',
      'fakeinbox.com', 'yopmail.com'
    ];
    
    const domain = email.split('@')[1]?.toLowerCase();
    if (blockedDomains.includes(domain)) {
      return "Please use a real email address, not temporary/fake emails";
    }
    
    const suspiciousPatterns = [
      /^test\d*@/i,
      /^fake\d*@/i,
      /^demo\d*@/i,
      /^admin@/i,
      /^sample@/i,
      /^user\d+@/i
    ];
    
    for (let pattern of suspiciousPatterns) {
      if (pattern.test(email)) {
        return "Please use a real email address";
      }
    }
    
    return null;
  }

  function calculatePasswordStrength(password) {
    let strength = 0;
    
    if (password.length >= 8) strength++;
    if (password.length >= 12) strength++;
    if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
    if (/\d/.test(password)) strength++;
    if (/[^a-zA-Z0-9]/.test(password)) strength++;
    
    return strength;
  }

  function validatePassword(password) {
    if (!password || password.length < 8) {
      return "Password must be at least 8 characters";
    }
    if (!/[a-zA-Z]/.test(password)) {
      return "Password must contain letters";
    }
    if (!/\d/.test(password)) {
      return "Password must contain at least one number";
    }
    return null;
  }

  // --- CHECK USERNAME UNIQUENESS ---
  
  async function isUsernameTaken(username) {
    try {
      const usersRef = collection(db, "users");
      const q = query(usersRef, where("usernameLower", "==", username.toLowerCase()));
      const snapshot = await getDocs(q);
      return !snapshot.empty;
    } catch (error) {
      console.error("Error checking username:", error);
      return false;
    }
  }

  // --- EMAIL EXISTENCE CHECK ---
  
  async function checkEmailExists(email) {
    const domain = email.split('@')[1];
    if (!domain) return false;
    
    try {
      const response = await fetch(`https://dns.google/resolve?name=${domain}&type=MX`);
      const data = await response.json();
      
      if (data.Answer && data.Answer.length > 0) {
        return true;
      }
      
      const aResponse = await fetch(`https://dns.google/resolve?name=${domain}&type=A`);
      const aData = await aResponse.json();
      
      return aData.Answer && aData.Answer.length > 0;
    } catch (error) {
      console.error("Email domain check failed:", error);
      return true;
    }
  }

  // --- UI HELPERS ---
  
  const inputs = {
    username: document.getElementById("username"),
    email: document.getElementById("email"),
    password: document.getElementById("password")
  };

  const errors = {
    username: document.getElementById("usernameError"),
    email: document.getElementById("emailError"),
    password: document.getElementById("passwordError")
  };

  const passwordWarning = document.getElementById("passwordWarning");
  const strengthBar = document.getElementById("strengthBar");

  function showError(field, message) {
    inputs[field].classList.remove("valid", "warning");
    inputs[field].classList.add("invalid");
    errors[field].textContent = message;
    errors[field].classList.add("show");
  }

  function showWarning(field, message) {
    inputs[field].classList.remove("valid", "invalid");
    inputs[field].classList.add("warning");
    if (field === "password") {
      passwordWarning.textContent = message;
      passwordWarning.classList.add("show");
    }
  }

  function clearError(field) {
    inputs[field].classList.remove("invalid", "warning");
    inputs[field].classList.add("valid");
    errors[field].classList.remove("show");
    if (field === "password") {
      passwordWarning.classList.remove("show");
    }
  }

  // --- REAL-TIME VALIDATION ---
  
  let usernameTimeout;
  inputs.username.addEventListener("input", async (e) => {
    const username = e.target.value.trim();
    const error = validateUsername(username);
    
    if (error) {
      showError("username", error);
    } else {
      clearTimeout(usernameTimeout);
      usernameTimeout = setTimeout(async () => {
        const taken = await isUsernameTaken(username);
        if (taken) {
          showError("username", "Username already taken");
        } else {
          clearError("username");
        }
      }, 500);
    }
  });

  let emailTimeout;
  inputs.email.addEventListener("input", (e) => {
    const email = e.target.value.trim();
    const error = validateEmail(email);
    
    if (error) {
      showError("email", error);
    } else {
      clearError("email");
      
      clearTimeout(emailTimeout);
      emailTimeout = setTimeout(async () => {
        const exists = await checkEmailExists(email);
        if (!exists) {
          showError("email", "Email domain doesn't exist or can't receive emails");
        }
      }, 800);
    }
  });

  let passwordTimeout;
  let lastPasswordBreachCheck = "";
  
  inputs.password.addEventListener("input", async (e) => {
    const password = e.target.value;
    const error = validatePassword(password);
    
    // Update strength bar
    const strength = calculatePasswordStrength(password);
    strengthBar.className = "password-strength-bar";
    if (strength >= 4) {
      strengthBar.classList.add("strong");
    } else if (strength >= 2) {
      strengthBar.classList.add("medium");
    } else if (password.length > 0) {
      strengthBar.classList.add("weak");
    }
    
    if (error) {
      showError("password", error);
      passwordWarning.classList.remove("show");
    } else {
      clearError("password");
      
      // Check for breaches (debounced)
      clearTimeout(passwordTimeout);
      passwordTimeout = setTimeout(async () => {
        if (password === lastPasswordBreachCheck) return;
        lastPasswordBreachCheck = password;
        
        const breachCount = await checkPasswordBreach(password);
        if (breachCount > 0) {
          showWarning("password", `‚ö†Ô∏è This password has been found in ${breachCount.toLocaleString()} data breaches. Choose a different one.`);
        } else {
          passwordWarning.classList.remove("show");
        }
      }, 1000);
    }
  });

  // --- SIGNUP FUNCTION ---

  window.signupUser = async function () {
    const username = inputs.username.value.trim();
    const email = inputs.email.value.trim();
    const password = inputs.password.value;

    // Validate all fields
    const usernameError = validateUsername(username);
    const emailError = validateEmail(email);
    const passwordError = validatePassword(password);

    if (usernameError) {
      showError("username", usernameError);
      return;
    }
    if (emailError) {
      showError("email", emailError);
      return;
    }
    if (passwordError) {
      showError("password", passwordError);
      return;
    }

    // Check username uniqueness
    const taken = await isUsernameTaken(username);
    if (taken) {
      showError("username", "Username already taken");
      return;
    }

    // Check email domain exists
    const emailExists = await checkEmailExists(email);
    if (!emailExists) {
      showError("email", "Email domain doesn't exist. Please use a real email.");
      return;
    }

    // CRITICAL: Check password breach
    const breachCount = await checkPasswordBreach(password);
    if (breachCount > 0) {
      showWarning("password", `‚ö†Ô∏è This password has been found in ${breachCount.toLocaleString()} data breaches. Please choose a different password.`);
      alert(`Security Warning: This password has appeared in ${breachCount.toLocaleString()} data breaches. Please choose a more secure password.`);
      return;
    }

    // Disable button during signup
    const btn = document.getElementById("signupBtn");
    btn.disabled = true;
    btn.textContent = "Creating Account...";
    document.querySelector(".card").classList.add("loading");

    try {
      // Get device ID for session tracking
      const deviceId = getDeviceId();
      
      // Create Firebase Auth account
      const cred = await createUserWithEmailAndPassword(auth, email, password);

      // Set display name
      await updateProfile(cred.user, {
        displayName: username
      });

      // Create Firestore user document with session tracking
      await setDoc(doc(db, "users", cred.user.uid), {
        username: username,
        usernameLower: username.toLowerCase(),
        email: email,
        best2048: 0,
        bestFlappy: 0,
        createdAt: new Date(),
        // Session management fields
        activeSessions: [deviceId],
        maxSessions: 2, // Allow max 2 devices
        currentGameSession: null, // Track if in multiplayer game
        lastActivity: new Date()
      });

      alert("Account created! üéâ");
      window.location.href = "index.html";

    } catch (error) {
      // Re-enable button on error
      btn.disabled = false;
      btn.textContent = "Sign Up";
      document.querySelector(".card").classList.remove("loading");

      let errorMessage = error.message;
      
      if (error.code === "auth/email-already-in-use") {
        errorMessage = "This email is already registered. Try logging in instead.";
        showError("email", "Email already in use");
      } else if (error.code === "auth/invalid-email") {
        errorMessage = "Invalid email format";
        showError("email", "Invalid email");
      } else if (error.code === "auth/weak-password") {
        errorMessage = "Password is too weak";
        showError("password", "Password too weak");
      }
      
      alert(errorMessage);
    }
  };
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>WebArcade | Dashboard</title>

<style>
/* --- SHARED THEME VARIABLES --- */
:root {
  --bg-base: #020617;
  --bg-card: rgba(15, 23, 42, 0.7);
  --accent: #6366f1;
  --accent-glow: rgba(99, 102, 241, 0.5);
  --text-main: #f8fafc;
  --text-muted: #94a3b8;
  --border: rgba(255, 255, 255, 0.1);
  --danger: #ef4444;
  --grid-color: rgba(99, 102, 241, 0.15);
}

* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: "Segoe UI", system-ui, sans-serif;
  background: var(--bg-base);
  color: var(--text-main);
  min-height: 100vh;
  overflow-x: hidden;
}

/* --- RETRO BACKGROUND --- */
.retro-bg {
  position: fixed;
  inset: 0;
  z-index: -1;
  background: 
    linear-gradient(transparent 0%, var(--bg-base) 100%),
    linear-gradient(0deg, transparent 24%, var(--grid-color) 25%, var(--grid-color) 26%, transparent 27%, transparent 74%, var(--grid-color) 75%, var(--grid-color) 76%, transparent 77%, transparent),
    linear-gradient(90deg, transparent 24%, var(--grid-color) 25%, var(--grid-color) 26%, transparent 27%, transparent 74%, var(--grid-color) 75%, var(--grid-color) 76%, transparent 77%, transparent);
  background-size: 50px 50px;
  transform: perspective(500px) rotateX(60deg) translateY(0) translateZ(-200px);
  animation: moveGrid 10s linear infinite;
  opacity: 0.6;
  pointer-events: none;
}
@keyframes moveGrid {
  0% { transform: perspective(500px) rotateX(60deg) translateY(0) translateZ(-200px); }
  100% { transform: perspective(500px) rotateX(60deg) translateY(50px) translateZ(-200px); }
}

/* --- HEADER --- */
header {
  padding: 15px 5%;
  display: flex;
  justify-content: space-between;
  align-items: center;
  backdrop-filter: blur(10px);
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  z-index: 10;
  background: rgba(2, 6, 23, 0.8);
}

header h2 {
  margin: 0;
  background: linear-gradient(to right, #fff, #a5b4fc);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  font-size: 1.5rem;
}

.profile-btn {
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  padding: 6px 12px;
  border-radius: 99px;
  transition: background 0.2s;
}
.profile-btn:hover { background: rgba(255,255,255,0.1); }

.profile-btn img {
  width: 36px; height: 36px; border-radius: 50%;
  border: 2px solid var(--accent);
}

/* --- SCROLLING TEXT --- */
.announcement {
  background: rgba(99, 102, 241, 0.1);
  border-bottom: 1px solid var(--border);
  overflow: hidden;
  display: flex;
  align-items: center;
  padding: 8px 0;
}
.announcement span {
  font-size: 13px;
  color: #a5b4fc;
  white-space: nowrap;
  animation: scroll 20s linear infinite;
  padding-left: 100%;
}
@keyframes scroll { 100% { transform: translateX(-100%); } }

/* --- MAIN LAYOUT --- */
.wrapper {
  max-width: 1100px;
  margin: 30px auto;
  padding: 0 20px;
  animation: fadeIn 0.8s ease;
}

@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* --- USER CARD --- */
.user-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 24px;
  display: flex;
  align-items: center;
  gap: 20px;
  margin-bottom: 40px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}
.avatar-lg { width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--accent); object-fit: cover; }
.name { font-size: 1.5rem; font-weight: 700; margin-bottom: 4px; }
.email { color: var(--text-muted); font-size: 0.9rem; }

/* --- GAMES GRID --- */
.games {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
  gap: 24px;
  margin-bottom: 40px;
}

.game-card {
  background: linear-gradient(180deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.9));
  border: 1px solid var(--border);
  border-radius: 18px;
  padding: 20px;
  text-align: center;
  transition: transform 0.2s, box-shadow 0.2s;
}

.game-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 25px var(--accent-glow);
  border-color: var(--accent);
}

.game-thumb {
  width: 100%; height: 140px;
  border-radius: 12px;
  object-fit: cover;
  margin-bottom: 15px;
  background: #000;
}

.play-btn {
  display: inline-block;
  margin-top: 15px;
  padding: 10px 28px;
  border-radius: 99px;
  background: var(--accent);
  color: white;
  text-decoration: none;
  font-weight: 700;
  box-shadow: 0 4px 15px var(--accent-glow);
  transition: 0.2s;
}
.play-btn:hover { transform: scale(1.05); filter: brightness(1.1); }

/* --- LEADERBOARD --- */
#leaderboard {
  list-style: none;
  padding: 0;
  background: var(--bg-card);
  border-radius: 16px;
  border: 1px solid var(--border);
}
#leaderboard li {
  padding: 14px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  font-size: 0.95rem;
}
#leaderboard li:last-child { border-bottom: none; }
#leaderboard li:nth-child(1) { color: #fbbf24; font-weight: bold; } /* Gold */
#leaderboard li:nth-child(2) { color: #94a3b8; font-weight: bold; } /* Silver */
#leaderboard li:nth-child(3) { color: #b45309; font-weight: bold; } /* Bronze */

/* --- DRAWER (Mobile Optimized) --- */
.overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,.7);
  backdrop-filter: blur(4px);
  display: none; z-index: 40;
}
.overlay.active { display: block; }

.drawer {
  position: fixed; top: 0; right: -100%; /* Hidden */
  width: 100%; max-width: 350px; /* Responsive Width */
  height: 100%;
  background: #0f172a;
  border-left: 1px solid var(--border);
  transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  padding: 24px;
  z-index: 50;
  box-shadow: -10px 0 40px rgba(0,0,0,0.5);
}
.drawer.open { right: 0; }

.setting { margin-top: 24px; }
.setting label { font-size: 13px; color: var(--text-muted); display: block; margin-bottom: 8px; }
.setting input {
  width: 100%; padding: 12px;
  background: rgba(0,0,0,0.3);
  border: 1px solid var(--border);
  color: #fff; border-radius: 10px;
  outline: none;
}
.setting input:focus { border-color: var(--accent); }

.action-btn {
  width: 100%; padding: 12px;
  margin-top: 10px;
  background: var(--accent);
  border: none; border-radius: 10px;
  color: #fff; font-weight: 600; cursor: pointer;
}
.danger-btn { background: var(--danger); }
.danger-btn:hover { background: #dc2626; }

/* Close Drawer Button */
.close-drawer {
  background: none; border: none;
  color: var(--text-muted); font-size: 24px;
  cursor: pointer; float: right;
}

footer { margin-top: 60px; padding: 30px; text-align: center; color: var(--text-muted); font-size: 14px; }
</style>
</head>

<body>

<div class="retro-bg"></div>

<header>
  <h2>WebArcade</h2>
  <div class="profile-btn" onclick="openDrawer()">
    <img id="avatarTop" src="https://i.imgur.com/8Km9tLL.png">
    <span id="usernameTop">Loading...</span>
  </div>
</header>

<div class="announcement">
  <span>ðŸš§ Website is still under development â€” developed by sknihal11 ðŸš§</span>
</div>

<div class="wrapper">

  <div class="user-card">
    <img id="avatar" class="avatar-lg" src="https://i.imgur.com/8Km9tLL.png">
    <div>
      <div class="name" id="displayName">Loading Player...</div>
      <div class="email" id="email">...</div>
    </div>
  </div>

  <h3>Available Games</h3>
  <div class="games">
    <div class="game-card">
      <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/18/2048_logo.svg/1200px-2048_logo.svg.png" class="game-thumb">
      <h3>2048</h3>
      <p style="color: var(--text-muted); font-size: 14px;">High Score: <b id="scoreDisplay" style="color: var(--accent);">0</b></p>
      <a href="2048.html" class="play-btn">â–¶ Play</a>
    </div>

    <div class="game-card">
      <img src="https://i.imgur.com/2yaf2wb.png" class="game-thumb">
      <h3>Flappy Bird</h3>
      <p style="color: var(--text-muted); font-size: 14px;">Tap to Fly</p>
      <a href="flappy.html" class="play-btn">â–¶ Play</a>
    </div>
  </div>

  <h3>Global Leaderboard (Top Players)</h3>
  <ul id="leaderboard">
    <li style="text-align:center;">Loading scores...</li>
  </ul>

</div>

<footer>Â© 2026 WebArcade | All Rights Reserved</footer>

<div class="overlay" id="overlay" onclick="closeDrawer()"></div>

<div class="drawer" id="drawer">
  <button class="close-drawer" onclick="closeDrawer()">Ã—</button>
  <h3>Settings</h3>

  <div class="setting">
    <label>Display Name</label>
    <input id="nameInput" placeholder="Enter new name">
    <button class="action-btn" onclick="saveName()">Save Name</button>
  </div>

  <div class="setting">
    <label>Avatar URL (Image Link)</label>
    <input id="avatarInput" placeholder="https://...">
    <button class="action-btn" onclick="saveAvatar()">Update Avatar</button>
  </div>

  <div class="setting">
    <button class="action-btn" style="background:#475569" onclick="logoutUser()">Log Out</button>
  </div>

  <div class="setting" style="margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border);">
    <label style="color: var(--danger);">Danger Zone</label>
    <button class="action-btn danger-btn" onclick="deleteAccount()">Delete Account</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import {
  getAuth,onAuthStateChanged,updateProfile,
  deleteUser,signOut
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import {
  getFirestore,doc,getDoc,collection,getDocs, query, orderBy, limit
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCzomf89xZhgcPsfYXKsYspCt-CiUVzjBA",
  authDomain: "webarcade-d4c3d.firebaseapp.com",
  projectId: "webarcade-d4c3d"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
let currentUser;

// --- SAFE DOM ELEMENTS ---
const els = {
    name: document.getElementById("displayName"),
    email: document.getElementById("email"),
    topName: document.getElementById("usernameTop"),
    avatar: document.getElementById("avatar"),
    topAvatar: document.getElementById("avatarTop"),
    score: document.getElementById("scoreDisplay"),
    leaderboard: document.getElementById("leaderboard"),
    drawer: document.getElementById("drawer"),
    overlay: document.getElementById("overlay"),
    nameInput: document.getElementById("nameInput"),
    avatarInput: document.getElementById("avatarInput")
};

// --- AUTH STATE LISTENER ---
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    location.replace("index.html");
    return;
  }
  currentUser = user;

  // 1. Update UI with basic Auth data
  els.name.textContent = user.displayName || "Player";
  els.topName.textContent = user.displayName || "Player";
  els.email.textContent = user.email;
  
  const photo = user.photoURL || "https://i.imgur.com/8Km9tLL.png";
  els.avatar.src = photo;
  els.topAvatar.src = photo;

  // 2. Fetch Firestore Data (Best Score)
  try {
      const docRef = doc(db, "users", user.uid);
      const snap = await getDoc(docRef);
      
      if (snap.exists()) {
        const data = snap.data();
        // FIXED: Using 'best2048' to match signup logic
        els.score.textContent = data.best2048 || 0;
      }
  } catch (e) {
      console.error("Error fetching user data:", e);
  }

  loadLeaderboard();
});

// --- LEADERBOARD LOGIC ---
async function loadLeaderboard() {
  els.leaderboard.innerHTML = "<li>Loading...</li>";
  
  try {
      // Fetch users. Ideally, you should use query(collection(db, "users"), orderBy("best2048", "desc"), limit(10))
      // But since indices might not be built yet, we will fetch and sort manually for now.
      const snap = await getDocs(collection(db, "users"));
      let players = [];
      
      snap.forEach(doc => {
        const d = doc.data();
        players.push({
            name: d.username || "Unknown",
            score: d.best2048 || 0 // FIXED FIELD NAME
        });
      });

      // Sort Descending
      players.sort((a, b) => b.score - a.score);

      // Render Top 5
      els.leaderboard.innerHTML = "";
      if(players.length === 0) {
          els.leaderboard.innerHTML = "<li>No scores yet. Be the first!</li>";
          return;
      }

      players.slice(0, 5).forEach((p, index) => {
         const li = document.createElement("li");
         li.innerHTML = `<span>#${index+1} ${p.name}</span> <span>${p.score}</span>`;
         els.leaderboard.appendChild(li);
      });

  } catch (e) {
      els.leaderboard.innerHTML = `<li style="color:var(--danger)">Error loading scores</li>`;
      console.error(e);
  }
}

// --- DRAWER FUNCTIONS ---
window.openDrawer = () => {
  els.drawer.classList.add("open");
  els.overlay.classList.add("active");
  // Pre-fill inputs
  els.nameInput.value = currentUser.displayName || "";
  els.avatarInput.value = currentUser.photoURL || "";
};

window.closeDrawer = () => {
  els.drawer.classList.remove("open");
  els.overlay.classList.remove("active");
};

window.saveName = async () => {
  const newName = els.nameInput.value.trim();
  if(!newName) return alert("Name cannot be empty");
  
  try {
    await updateProfile(currentUser, { displayName: newName });
    els.name.textContent = newName;
    els.topName.textContent = newName;
    alert("Name updated!");
  } catch(e) { alert(e.message); }
};

window.saveAvatar = async () => {
  const newUrl = els.avatarInput.value.trim();
  if(!newUrl) return alert("URL cannot be empty");

  try {
    await updateProfile(currentUser, { photoURL: newUrl });
    els.avatar.src = newUrl;
    els.topAvatar.src = newUrl;
    alert("Avatar updated!");
  } catch(e) { alert(e.message); }
};

window.logoutUser = async () => {
  await signOut(auth);
  location.replace("index.html");
};

window.deleteAccount = async () => {
  if (confirm("Are you sure? This cannot be undone.")) {
    try {
      await deleteUser(currentUser);
      location.replace("index.html");
    } catch(e) { alert("Error: " + e.message + " (You may need to re-login to delete)"); }
  }
};
</script>

</body>
</html>

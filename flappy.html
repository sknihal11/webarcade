<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Flappy Bird – WebArcade</title>

<style>
/* --- CORE VARIABLES --- */
:root {
  --bg-dark: #020617;
  --accent: #facc15;
}

* { margin:0; padding:0; box-sizing:border-box; font-family:"Segoe UI", sans-serif; }

body {
  min-height: 100vh;
  background-color: var(--bg-dark);
  display: flex;
  justify-content: center;
  align-items: center;
  overflow: hidden;
  user-select: none;
  touch-action: none;
}

/* --- RETRO BACKGROUND --- */
.retro-bg {
  position: fixed; inset: 0; z-index: -1;
  background: 
    linear-gradient(transparent 95%, rgba(99, 102, 241, 0.1) 95%),
    linear-gradient(90deg, transparent 95%, rgba(99, 102, 241, 0.1) 95%);
  background-size: 40px 40px;
  transform: perspective(500px) rotateX(20deg);
  opacity: 0.3; pointer-events: none;
}

/* --- GAME CONTAINER --- */
#game-container {
  position: relative;
  width: 400px;
  height: 600px;
  background: #4ec0ca; /* Sky */
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 20px 60px rgba(0,0,0,0.6);
  border: 4px solid #334155;
  image-rendering: pixelated; 
}

@media(max-width: 420px) {
  #game-container { width: 100%; height: 100vh; border: none; border-radius: 0; }
}

/* --- SCENERY --- */
.scenery { position: absolute; width: 100%; pointer-events: none; }

#city {
  bottom: 60px; height: 150px; width: 200%;
  background: repeat-x bottom left url('https://i.imgur.com/Q6amLgA.png'); 
  background-size: contain;
  z-index: 1;
}

#clouds {
  bottom: 150px; height: 100px; width: 200%;
  opacity: 0.8;
  background: repeat-x bottom left url('https://i.imgur.com/z48eI5w.png');
  background-size: contain;
  z-index: 0;
}

/* --- UI ELEMENTS --- */
.ui-layer {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  pointer-events: none; z-index: 50;
}

.back-btn {
  position: absolute; top: 15px; left: 15px;
  background: rgba(0,0,0,0.5); color: white;
  padding: 8px 14px; border-radius: 99px;
  text-decoration: none; font-weight: bold; font-size: 13px;
  pointer-events: auto; backdrop-filter: blur(4px);
  border: 1px solid rgba(255,255,255,0.2);
}

.world-record {
  position: absolute; top: 15px; right: 15px;
  background: rgba(0,0,0,0.5); color: #fbbf24;
  padding: 6px 12px; border-radius: 8px;
  font-size: 12px; font-weight: bold;
  text-align: right;
  border: 1px solid rgba(251, 191, 36, 0.3);
}
.world-record span { display: block; font-size: 16px; color: #fff; }

.score-display {
  position: absolute; top: 60px; width: 100%;
  text-align: center; font-size: 56px; font-weight: 900;
  color: white; 
  text-shadow: 2px 2px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
  z-index: 50;
}

.start-msg {
  position: absolute; top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  width: 184px; height: 267px;
  background: url('https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/message.png') no-repeat center;
  background-size: contain;
  z-index: 40;
}

/* --- GAME OBJECTS --- */
#bird {
  position: absolute;
  width: 34px; height: 24px;
  background-image: url('https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/yellowbird-midflap.png');
  background-size: contain;
  background-repeat: no-repeat;
  z-index: 20;
}

/* DEBUG HITBOX: Uncomment to see the actual collision box */
/* #bird { border: 1px solid red; } */

.pipe {
  position: absolute; width: 52px;
  background: url('https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/pipe-green.png');
  background-size: 100% 100%;
  z-index: 10;
  border: 2px solid #533846;
}
.pipe.top-pipe { transform: scaleY(-1); border-bottom: none; }
.pipe.btm-pipe { border-top: none; }

#ground {
  position: absolute; bottom: 0; width: 100%; height: 60px;
  background: url('https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/base.png');
  background-size: auto 60px;
  z-index: 30;
  border-top: 2px solid #533846;
}

/* --- GAME OVER --- */
#game-over-screen {
  position: absolute; inset: 0;
  background: rgba(0,0,0,0.6);
  display: none; flex-direction: column;
  align-items: center; justify-content: center;
  z-index: 60; pointer-events: auto; opacity: 0;
  transition: opacity 0.3s;
}
#game-over-screen.show { opacity: 1; }

.panel {
  background: #ded895;
  border: 2px solid #543847;
  padding: 20px; border-radius: 8px;
  text-align: center; width: 240px;
  box-shadow: inset 0 0 0 2px #9e9a6b, 0 10px 20px rgba(0,0,0,0.5);
  margin-bottom: 20px;
  position: relative;
}
.panel h2 { color: #e86101; font-size: 28px; text-shadow: 2px 2px 0 #fff; margin-bottom: 15px; }
.panel-row { display: flex; justify-content: space-between; margin: 10px 0; font-weight: bold; color: #e86101; }
.panel-row span { color: #fff; font-size: 20px; text-shadow: 1px 1px 0 #000; }

.play-btn {
  background: #e86101; border: 2px solid #fff;
  color: white; padding: 12px 30px; font-weight: bold; font-size: 18px;
  cursor: pointer; box-shadow: 0 4px 0 #bc4f01;
  border-radius: 4px;
}
.play-btn:active { transform: translateY(4px); box-shadow: 0 0 0 #bc4f01; }

/* Flash effect */
#flash {
  position: absolute; inset: 0; background: white; 
  z-index: 100; opacity: 0; pointer-events: none;
}
</style>
</head>

<body>

<div class="retro-bg"></div>

<div id="game-container">
  
  <div class="scenery" id="clouds"></div>
  <div class="scenery" id="city"></div>

  <div class="ui-layer">
    <a href="blog.html" class="back-btn">← Back</a>
    
    <div class="world-record">
      Global Best
      <span id="globalBest">Loading...</span>
    </div>

    <div class="score-display" id="scoreEl">0</div>
    <div class="start-msg" id="startMsg"></div>
    <div id="flash"></div>
  </div>

  <div id="bird"></div>
  <div id="pipes-container"></div>
  <div id="ground"></div>

  <div id="game-over-screen">
    <div class="panel">
      <h2>GAME OVER</h2>
      <div class="panel-row">Score <span id="finalScore">0</span></div>
      <div class="panel-row">Best <span id="bestScore">0</span></div>
    </div>
    <button class="play-btn" onclick="resetGame()">PLAY AGAIN</button>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { 
  getFirestore, doc, setDoc, getDoc, collection, query, orderBy, limit, getDocs 
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

/* --- FIREBASE --- */
const app = initializeApp({
  apiKey: "AIzaSyCzomf89xZhgcPsfYXKsYspCt-CiUVzjBA",
  authDomain: "webarcade-d4c3d.firebaseapp.com",
  projectId: "webarcade-d4c3d"
});
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let personalBest = 0;
let worldRecord = 0;

/* --- ASSETS & AUDIO --- */
const sprites = {
  bird: [
    'https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/yellowbird-upflap.png',
    'https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/yellowbird-midflap.png',
    'https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/yellowbird-downflap.png'
  ]
};

// Preload
sprites.bird.forEach(src => { const img = new Image(); img.src = src; });

const ctx = new (window.AudioContext || window.webkitAudioContext)();
function playSound(type) {
  if (ctx.state === 'suspended') ctx.resume();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.connect(gain);
  gain.connect(ctx.destination);

  if (type === 'flap') {
    osc.frequency.setValueAtTime(400, ctx.currentTime);
    osc.type = 'triangle';
    gain.gain.setValueAtTime(0.1, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
    osc.start(); osc.stop(ctx.currentTime + 0.1);
  } else if (type === 'point') {
    osc.frequency.setValueAtTime(1200, ctx.currentTime);
    osc.type = 'sine';
    gain.gain.setValueAtTime(0.1, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
    osc.start(); osc.stop(ctx.currentTime + 0.15);
  } else if (type === 'hit') {
    osc.frequency.setValueAtTime(150, ctx.currentTime);
    osc.type = 'sawtooth';
    gain.gain.setValueAtTime(0.2, ctx.currentTime);
    gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.3);
    osc.start(); osc.stop(ctx.currentTime + 0.3);
  }
}

/* --- GAME STATE --- */
const container = document.getElementById("game-container");
const birdEl = document.getElementById("bird");
const pipesCont = document.getElementById("pipes-container");
const scoreEl = document.getElementById("scoreEl");
const ground = document.getElementById("ground");
const city = document.getElementById("city");
const clouds = document.getElementById("clouds");

let width, height;
let frames = 0;
let score = 0;
let state = 'START'; 
let birdY, birdVel;
const GRAVITY = 0.25;
const JUMP = -4.6;
const SPEED = 2.5;
let pipes = [];

/* --- INIT --- */
function resize() {
  width = container.offsetWidth;
  height = container.offsetHeight;
}
window.onresize = resize;
resize();

// Load Data
onAuthStateChanged(auth, async (u) => {
  currentUser = u;
  fetchGlobalBest();
  if(u) {
    try {
      const s = await getDoc(doc(db, "users", u.uid));
      if(s.exists()) personalBest = s.data().bestFlappy || 0;
    } catch(e) {}
  } else {
    personalBest = Number(localStorage.getItem("bestFlappy") || 0);
  }
});

async function fetchGlobalBest() {
  try {
    const q = query(collection(db, "users"), orderBy("bestFlappy", "desc"), limit(1));
    const snap = await getDocs(q);
    if (!snap.empty) {
      worldRecord = snap.docs[0].data().bestFlappy || 0;
      document.getElementById("globalBest").textContent = worldRecord;
    } else {
      document.getElementById("globalBest").textContent = "0";
    }
  } catch (e) { console.error(e); }
}

/* --- LOOP --- */
function loop() {
  if (state === 'PLAY') {
    update();
  }
  
  if (state === 'PLAY' || state === 'START') {
    let pos = (frames * SPEED) % 24; 
    ground.style.backgroundPosition = `-${pos}px 0`;
    city.style.backgroundPosition = `-${frames * 0.5}px bottom`;
    clouds.style.backgroundPosition = `-${frames * 0.2}px bottom`;
    
    // Animate Bird Wing
    let flapSpeed = birdVel < 0 ? 5 : 10;
    let frameIndex = Math.floor(frames / flapSpeed) % 3;
    if(birdVel > 5) frameIndex = 1; 
    birdEl.style.backgroundImage = `url(${sprites.bird[frameIndex]})`;
  }
  
  if (state === 'PLAY') frames++;
  requestAnimationFrame(loop);
}

/* --- UPDATE (FIXED COLLISION) --- */
function update() {
  birdVel += GRAVITY;
  birdY += birdVel;
  
  // Rotation
  let rot = Math.min(Math.max(birdVel * 6, -25), 90);
  birdEl.style.transform = `translate(0, ${birdY}px) rotate(${rot}deg)`;

  // Ground Hit
  if (birdY + 24 >= height - 60) {
    hit();
    return;
  }

  // Pipe Logic
  if (frames % 100 === 0) createPipe();

  pipes.forEach(p => {
    p.x -= SPEED;
    p.top.style.left = p.x + 'px';
    p.btm.style.left = p.x + 'px';

    /* --- IMPROVED HITBOX (FORGIVING) --- */
    // Bird is visually 34px wide, 24px high.
    // The previous hitbox was checking 34x24 which is too strict.
    // We shrink the hitbox by ~6px on all sides.
    const paddingX = 6; 
    const paddingY = 6;

    // Bird Hitbox
    const bLeft = 50 + paddingX;
    const bRight = 50 + 34 - paddingX;
    const bTop = birdY + paddingY;
    const bBtm = birdY + 24 - paddingY;

    // Pipe Hitbox
    const pLeft = p.x;
    const pRight = p.x + 52;
    const pTopY = p.h; // Bottom of top pipe
    const pBtmY = p.h + 140; // Top of bottom pipe

    // Check collision
    if (bRight > pLeft && bLeft < pRight) {
       // We are horizontally inside the pipe
       if (bTop < pTopY || bBtm > pBtmY) {
           hit();
       }
    }

    // Score
    if (!p.passed && p.x < 50) {
      p.passed = true;
      score++;
      scoreEl.innerText = score;
      playSound('point');
    }
  });

  // Remove pipes
  if (pipes.length > 0 && pipes[0].x < -60) {
    pipes[0].top.remove();
    pipes[0].btm.remove();
    pipes.shift();
  }
}

function createPipe() {
  const gap = 140;
  const minPipe = 50;
  const maxPipe = height - 60 - gap - minPipe;
  const h = Math.floor(Math.random() * (maxPipe - minPipe + 1)) + minPipe;

  const top = document.createElement('div');
  top.className = 'pipe top-pipe';
  top.style.height = h + 'px';
  top.style.left = width + 'px';
  top.style.top = '0';

  const btm = document.createElement('div');
  btm.className = 'pipe btm-pipe';
  btm.style.height = (height - 60 - gap - h) + 'px';
  btm.style.left = width + 'px';
  btm.style.bottom = '60px'; 

  pipesCont.appendChild(top);
  pipesCont.appendChild(btm);
  pipes.push({ x: width, h: h, top: top, btm: btm, passed: false });
}

function hit() {
  state = 'OVER';
  playSound('hit');
  
  const flash = document.getElementById("flash");
  flash.style.opacity = 0.6;
  setTimeout(() => flash.style.opacity = 0, 100);

  birdEl.style.transition = 'transform 0.5s ease-in';
  birdEl.style.transform = `translate(0, ${height - 60 - 24}px) rotate(90deg)`;

  if (score > personalBest) {
    personalBest = score;
    localStorage.setItem("bestFlappy", personalBest);
    if(currentUser) {
      setDoc(doc(db, "users", currentUser.uid), { bestFlappy: personalBest }, { merge: true })
        .then(() => fetchGlobalBest()); 
    }
  }

  document.getElementById("game-over-screen").style.display = 'flex';
  setTimeout(() => document.getElementById("game-over-screen").classList.add('show'), 50);
  document.getElementById("finalScore").innerText = score;
  document.getElementById("bestScore").innerText = personalBest;
  scoreEl.style.display = 'none';
}

function flap() {
  if (state === 'OVER') return;
  if (state === 'START') {
    state = 'PLAY';
    document.getElementById("startMsg").style.display = 'none';
  }
  birdVel = JUMP;
  playSound('flap');
}

window.resetGame = () => {
  pipesCont.innerHTML = '';
  pipes = [];
  score = 0;
  frames = 0;
  birdY = height / 2 - 20;
  birdVel = 0;
  state = 'START';
  
  scoreEl.innerText = '0';
  scoreEl.style.display = 'block';
  document.getElementById("game-over-screen").style.display = 'none';
  document.getElementById("game-over-screen").classList.remove('show');
  document.getElementById("startMsg").style.display = 'block';
  
  birdEl.style.transition = 'none';
  birdEl.style.transform = `translate(0, ${birdY}px)`;
  birdEl.style.backgroundImage = `url(${sprites.bird[1]})`;
};

window.addEventListener('keydown', e => { if(e.code==='Space') { e.preventDefault(); flap(); } });
container.addEventListener('touchstart', e => { e.preventDefault(); flap(); }, {passive:false});
container.addEventListener('mousedown', e => { if(e.target.className!=='play-btn') flap(); });

resetGame();
loop();
</script>

</body>
</html>

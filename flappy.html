<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Flappy Bird – WebArcade</title>

<style>
/* --- VARIABLES --- */
:root {
  --bg-dark: #111;
  --cabinet-color: #222;
  --neon-blue: #00f3ff;
}

* { margin:0; padding:0; box-sizing:border-box; font-family:"Segoe UI", sans-serif; }

body {
  min-height: 100vh;
  background-color: var(--bg-dark);
  display: flex;
  justify-content: center;
  align-items: center;
  overflow: hidden;
  user-select: none;
  touch-action: none;
}

/* --- ARCADE AMBIANCE --- */
.arcade-room {
  position: fixed; inset: 0; z-index: -1;
  background: radial-gradient(circle at center, #1a1a2e 0%, #000 100%);
}

.arcade-glow {
  position: absolute; inset: 0;
  background-image: 
    linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
    linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
  background-size: 100% 2px, 3px 100%;
  pointer-events: none;
}

/* --- GAME SCREEN --- */
#game-container {
  position: relative;
  width: 400px;
  height: 600px;
  background: #000; /* Start black to hide flash */
  overflow: hidden;
  border: 8px solid var(--cabinet-color);
  border-radius: 4px;
  box-shadow: 0 0 0 4px #000, 0 0 20px var(--neon-blue);
  image-rendering: pixelated; 
}

@media(max-width: 450px) {
  #game-container { width: 100%; height: 100vh; border: none; box-shadow: none; border-radius: 0; }
}

/* --- LOADING SCREEN (HIGHEST Z-INDEX) --- */
#loader {
  position: absolute; inset: 0;
  background: #000;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  z-index: 9999; /* Covers EVERYTHING */
  color: #00f3ff; font-weight: bold; font-size: 14px; letter-spacing: 2px;
  transition: opacity 0.5s ease-out;
}
.loader-bar {
  width: 150px; height: 4px; background: #333; margin-top: 10px; border-radius: 2px; overflow: hidden;
}
.loader-progress {
  width: 0%; height: 100%; background: #00f3ff; transition: width 0.1s;
}
.loader-error {
  color: #ff4444; margin-top: 10px; font-size: 12px;
}

/* --- LAYERS --- */
.scenery { position: absolute; width: 100%; pointer-events: none; opacity: 0; transition: opacity 0.5s; }
.scenery.loaded { opacity: 1; }

#bg-art {
  bottom: 0; height: 100%; width: 100%;
  background-size: cover;
  z-index: 0;
}

#ground {
  position: absolute; bottom: 0; width: 100%; height: 112px;
  background-size: auto 112px;
  z-index: 30;
  opacity: 0; transition: opacity 0.5s;
}
#ground.loaded { opacity: 1; }

/* --- UI --- */
.ui-layer {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  pointer-events: none; z-index: 50;
  opacity: 0; transition: opacity 0.5s;
}
.ui-layer.loaded { opacity: 1; }

.back-btn {
  position: absolute; top: 20px; left: 20px;
  background: #e86101; color: white; border: 2px solid #fff;
  padding: 8px 14px; border-radius: 6px;
  text-decoration: none; font-weight: bold; font-size: 14px;
  pointer-events: auto; box-shadow: 0 4px 0 #bc4f01;
}
.back-btn:active { transform: translateY(4px); box-shadow: none; }

.world-record {
  position: absolute; top: 20px; right: 20px;
  background: rgba(0,0,0,0.6); color: #fbbf24;
  padding: 6px 12px; border-radius: 6px;
  font-size: 12px; font-weight: bold;
  text-align: right;
  border: 2px solid rgba(255,255,255,0.2);
}
.world-record span { display: block; font-size: 16px; color: #fff; }

.score-display {
  position: absolute; top: 80px; width: 100%;
  text-align: center; font-size: 60px; font-weight: 900;
  color: white; 
  text-shadow: 3px 3px 0 #000;
  z-index: 50;
}

.start-msg {
  position: absolute; top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  width: 184px; height: 267px;
  background-size: contain;
  background-repeat: no-repeat;
  z-index: 40;
  display: none;
}

/* --- OBJECTS --- */
#bird {
  position: absolute;
  width: 34px; height: 24px;
  background-size: contain;
  background-repeat: no-repeat;
  z-index: 20;
  opacity: 0;
}
#bird.loaded { opacity: 1; }

.pipe {
  position: absolute; width: 52px;
  background-size: 100% 100%;
  z-index: 10;
}
.pipe.top-pipe { transform: scaleY(-1); }

/* --- GAME OVER --- */
#game-over-screen {
  position: absolute; inset: 0;
  background: rgba(0,0,0,0.4);
  display: none; flex-direction: column;
  align-items: center; justify-content: center;
  z-index: 60; 
  opacity: 0;
  transition: opacity 0.3s;
}
#game-over-screen.show { opacity: 1; }

.game-over-logo {
  width: 192px; height: 42px; margin-bottom: 20px;
  background-size: contain; background-repeat: no-repeat;
}

.panel {
  background: #ded895;
  border: 2px solid #543847;
  padding: 20px; border-radius: 8px;
  text-align: center; width: 240px;
  box-shadow: inset 0 0 0 2px #9e9a6b, 0 10px 20px rgba(0,0,0,0.5);
  margin-bottom: 20px;
}
.panel-row { display: flex; justify-content: space-between; margin: 10px 0; font-weight: bold; color: #e86101; }
.panel-row span { color: #fff; font-size: 20px; text-shadow: 1px 1px 0 #000; }

.play-btn {
  background: #52c3cc; border: 2px solid #fff;
  color: white; padding: 12px 30px; font-weight: bold; font-size: 18px;
  cursor: pointer; box-shadow: 0 4px 0 #3b9099;
  border-radius: 4px; text-shadow: 1px 1px 0 #3b9099;
  pointer-events: auto;
}
.play-btn:active { transform: translateY(4px); box-shadow: none; }

#flash {
  position: absolute; inset: 0; background: white; 
  z-index: 100; opacity: 0; pointer-events: none;
}
</style>
</head>

<body>

<div class="arcade-room"><div class="arcade-glow"></div></div>

<div id="game-container">
  <div id="loader">
    INITIALIZING...
    <div class="loader-bar"><div class="loader-progress" id="progress"></div></div>
    <div class="loader-error" id="loaderError"></div>
  </div>

  <div class="scenery" id="bg-art"></div>

  <div class="ui-layer" id="uiLayer">
    <a href="blog.html" class="back-btn">← DASHBOARD</a>
    <div class="world-record">WORLD BEST <span id="globalBest">-</span></div>
    <div class="score-display" id="scoreEl">0</div>
    <div class="start-msg" id="startMsg"></div>
    <div id="flash"></div>
  </div>

  <div id="bird"></div>
  <div id="pipes-container"></div>
  <div id="ground"></div>

  <div id="game-over-screen">
    <div class="game-over-logo" id="goLogo"></div>
    <div class="panel">
      <div class="panel-row">Score <span id="finalScore">0</span></div>
      <div class="panel-row">Best <span id="bestScore">0</span></div>
    </div>
    <button class="play-btn" id="playBtn">PLAY</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

/* --- FIREBASE --- */
const app = initializeApp({
  apiKey: "AIzaSyCzomf89xZhgcPsfYXKsYspCt-CiUVzjBA",
  authDomain: "webarcade-d4c3d.firebaseapp.com",
  projectId: "webarcade-d4c3d"
});
const auth = getAuth(app);
const db = getFirestore(app);

/* --- CONSTANTS --- */
const BIRD_X = 50;
const BIRD_WIDTH = 34;
const BIRD_HEIGHT = 24;
const PIPE_WIDTH = 52;
const GROUND_HEIGHT = 112;
const PIPE_GAP = 120;
const GRAVITY = 0.25;
const JUMP = -4.6;
const SPEED = 2;
const GROUND_SPRITE_WIDTH = 336;

// Hitbox margins (smaller than actual sprite for forgiving gameplay)
const BIRD_HITBOX_MARGIN_TOP = 2;
const BIRD_HITBOX_MARGIN_BOTTOM = 2;
const BIRD_HITBOX_MARGIN_LEFT = 2;
const BIRD_HITBOX_MARGIN_RIGHT = 2;

/* --- ASSET PRELOADER --- */
const assets = {
  bg: 'https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/background-day.png',
  ground: 'https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/base.png',
  msg: 'https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/message.png',
  pipe: 'https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/pipe-green.png',
  bird1: 'https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/yellowbird-midflap.png',
  bird2: 'https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/yellowbird-upflap.png',
  bird3: 'https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/yellowbird-downflap.png',
  over: 'https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/gameover.png'
};

const loader = document.getElementById("loader");
const progress = document.getElementById("progress");
const loaderError = document.getElementById("loaderError");
let loadedCount = 0;
let failedCount = 0;
const totalAssets = Object.keys(assets).length;
let assetsLoaded = false;

// Preload Loop with Error Handling
function preloadGame() {
  Object.entries(assets).forEach(([key, url]) => {
    const img = new Image();
    img.crossOrigin = "anonymous";
    
    img.onload = () => {
      loadedCount++;
      updateProgress();
    };
    
    img.onerror = () => {
      failedCount++;
      console.error(`Failed to load ${key}: ${url}`);
      loaderError.textContent = `Failed to load ${failedCount} asset(s). Retrying...`;
      
      // Retry once
      setTimeout(() => {
        const retryImg = new Image();
        retryImg.crossOrigin = "anonymous";
        retryImg.onload = () => {
          loadedCount++;
          updateProgress();
        };
        retryImg.onerror = () => {
          loadedCount++; // Count as loaded to not block game
          updateProgress();
        };
        retryImg.src = url;
      }, 1000);
    };
    
    img.src = url;
  });
}

function updateProgress() {
  progress.style.width = (loadedCount / totalAssets) * 100 + "%";
  
  if(loadedCount === totalAssets) {
    assetsLoaded = true;
    applyAssets();
    setTimeout(revealGame, 500);
  }
}

function applyAssets() {
  // Apply Backgrounds via CSS only AFTER load
  document.getElementById('bg-art').style.backgroundImage = `url(${assets.bg})`;
  document.getElementById('ground').style.backgroundImage = `url(${assets.ground})`;
  document.getElementById('startMsg').style.backgroundImage = `url(${assets.msg})`;
  document.getElementById('goLogo').style.backgroundImage = `url(${assets.over})`;
  
  // Inject pipe style
  const style = document.createElement('style');
  style.innerHTML = `.pipe { background-image: url(${assets.pipe}); }`;
  document.head.appendChild(style);
}

function revealGame() {
  // Fade out loader
  loader.style.opacity = 0;
  
  // Fade in elements
  document.getElementById('bg-art').classList.add('loaded');
  document.getElementById('ground').classList.add('loaded');
  document.getElementById('bird').classList.add('loaded');
  document.getElementById('uiLayer').classList.add('loaded');
  
  setTimeout(() => {
    loader.style.display = 'none';
    resetGame();
    if (!gameLoopRunning) {
      gameLoopRunning = true;
      loop();
    }
  }, 500);
}

/* --- GAME LOGIC --- */
const container = document.getElementById("game-container");
const birdEl = document.getElementById("bird");
const pipesCont = document.getElementById("pipes-container");
const scoreEl = document.getElementById("scoreEl");
const ground = document.getElementById("ground");

let width = container.offsetWidth;
let height = container.offsetHeight;

let frames = 0;
let score = 0;
let state = 'START'; 
let birdY, birdVel;
let pipes = [];
let gameLoopRunning = false;

let currentUser, personalBest = 0, worldRecord = 0;

// Handle window resize
let resizeTimeout;
window.addEventListener('resize', () => {
  clearTimeout(resizeTimeout);
  resizeTimeout = setTimeout(() => {
    width = container.offsetWidth;
    height = container.offsetHeight;
    
    // Adjust bird position if needed
    const groundY = height - GROUND_HEIGHT;
    if (birdY + BIRD_HEIGHT > groundY) {
      birdY = groundY - BIRD_HEIGHT;
    }
  }, 250);
});

/* --- AUTH --- */
onAuthStateChanged(auth, async (u) => {
  currentUser = u;
  fetchGlobalBest();
  if(u) {
    try {
      const s = await getDoc(doc(db, "users", u.uid));
      if(s.exists()) personalBest = s.data().bestFlappy || 0;
    } catch(e) {
      console.error("Failed to fetch personal best:", e);
    }
  } else {
    personalBest = Number(localStorage.getItem("bestFlappy") || 0);
  }
});

async function fetchGlobalBest() {
  try {
    const q = query(collection(db, "users"), orderBy("bestFlappy", "desc"), limit(1));
    const snap = await getDocs(q);
    if (!snap.empty) {
      worldRecord = snap.docs[0].data().bestFlappy || 0;
      document.getElementById("globalBest").textContent = worldRecord;
    }
  } catch(e) {
    console.error("Failed to fetch global best:", e);
  }
}

/* --- LOOP --- */
function loop() {
  if (!gameLoopRunning) return;
  
  if (state === 'PLAY') update();
  
  // Animation (Ground scroll)
  if (state !== 'OVER') {
    let pos = (frames * SPEED) % GROUND_SPRITE_WIDTH; 
    ground.style.transform = `translateX(-${pos}px)`;
    
    // Bird Flap Animation
    let flapSpeed = 8;
    let index = Math.floor(frames / flapSpeed) % 3;
    
    // Use Preloaded URLs
    const birdSprites = [assets.bird2, assets.bird1, assets.bird3];
    birdEl.style.backgroundImage = `url(${birdSprites[index]})`;
  }
  
  if (state === 'PLAY') frames++;
  requestAnimationFrame(loop);
}

/* --- UPDATE --- */
function update() {
  birdVel += GRAVITY;
  birdY += birdVel;

  // Rotation
  let rot = Math.min(Math.max(birdVel * 6, -25), 90);
  birdEl.style.transform = `translate(${BIRD_X}px, ${birdY}px) rotate(${rot}deg)`;

  // Ceiling Hit
  if (birdY < 0) {
    birdY = 0;
    birdVel = 0;
  }

  // Ground Hit
  const groundY = height - GROUND_HEIGHT; 
  if (birdY + BIRD_HEIGHT >= groundY) {
    birdY = groundY - BIRD_HEIGHT;
    hit();
    return;
  }

  // Pipe Management
  if (frames % 120 === 0) createPipe();

  pipes.forEach(p => {
    p.x -= SPEED;
    p.top.style.left = p.x + 'px';
    p.btm.style.left = p.x + 'px';

    // Collision Detection with proper hitboxes
    const birdLeft = BIRD_X + BIRD_HITBOX_MARGIN_LEFT;
    const birdRight = BIRD_X + BIRD_WIDTH - BIRD_HITBOX_MARGIN_RIGHT;
    const birdTop = birdY + BIRD_HITBOX_MARGIN_TOP;
    const birdBottom = birdY + BIRD_HEIGHT - BIRD_HITBOX_MARGIN_BOTTOM;
    
    const pipeLeft = p.x;
    const pipeRight = p.x + PIPE_WIDTH;
    const topPipeBottom = p.h;
    const bottomPipeTop = p.h + PIPE_GAP;

    // Check horizontal overlap
    if (birdRight > pipeLeft && birdLeft < pipeRight) {
      // Check vertical collision (bird hits pipe if NOT in gap)
      if (birdTop < topPipeBottom || birdBottom > bottomPipeTop) {
        hit();
      }
    }

    // Score
    if (!p.passed && p.x + PIPE_WIDTH < BIRD_X) {
      p.passed = true;
      score++;
      scoreEl.innerText = score;
      playSound('point');
    }
  });

  // Cleanup off-screen pipes
  if (pipes.length > 0 && pipes[0].x < -PIPE_WIDTH) {
    pipes[0].top.remove();
    pipes[0].btm.remove();
    pipes.shift();
  }
}

function createPipe() {
  const MIN_PIPE_HEIGHT = 50;
  const maxTopHeight = height - GROUND_HEIGHT - PIPE_GAP - MIN_PIPE_HEIGHT;
  
  // Ensure valid range
  if (maxTopHeight < MIN_PIPE_HEIGHT) {
    console.warn("Screen too small for pipes");
    return;
  }
  
  const h = Math.floor(Math.random() * (maxTopHeight - MIN_PIPE_HEIGHT + 1)) + MIN_PIPE_HEIGHT;

  const top = document.createElement('div');
  top.className = 'pipe top-pipe';
  top.style.height = h + 'px';
  top.style.left = width + 'px';
  top.style.top = '0';

  const bottomHeight = height - GROUND_HEIGHT - PIPE_GAP - h;
  const btm = document.createElement('div');
  btm.className = 'pipe';
  btm.style.height = bottomHeight + 'px';
  btm.style.left = width + 'px';
  btm.style.bottom = GROUND_HEIGHT + 'px'; 

  pipesCont.appendChild(top);
  pipesCont.appendChild(btm);
  pipes.push({ x: width, h: h, top: top, btm: btm, passed: false });
}

function hit() {
  if (state === 'OVER') return; // Prevent multiple hits
  
  state = 'OVER';
  playSound('hit');
  
  const flash = document.getElementById("flash");
  flash.style.opacity = 0.8;
  setTimeout(() => flash.style.opacity = 0, 100);

  birdEl.style.transition = 'transform 0.5s ease-in';
  const groundY = height - GROUND_HEIGHT;
  birdEl.style.transform = `translate(${BIRD_X}px, ${groundY - BIRD_HEIGHT}px) rotate(90deg)`;

  // Update best score
  if (score > personalBest) {
    const newBest = score;
    personalBest = newBest;
    localStorage.setItem("bestFlappy", personalBest);
    
    if(currentUser) {
      setDoc(doc(db, "users", currentUser.uid), { bestFlappy: newBest }, { merge: true })
        .then(() => {
          fetchGlobalBest();
        })
        .catch(e => {
          console.error("Failed to save best score:", e);
        });
    }
  }

  document.getElementById("game-over-screen").style.display = 'flex';
  setTimeout(() => document.getElementById("game-over-screen").classList.add('show'), 50);
  document.getElementById("finalScore").innerText = score;
  document.getElementById("bestScore").innerText = personalBest;
  scoreEl.style.display = 'none';
}

function flap() {
  if (state === 'OVER') return;
  if (state === 'START') {
    state = 'PLAY';
    document.getElementById("startMsg").style.display = 'none';
  }
  birdVel = JUMP;
  playSound('flap');
}

window.resetGame = () => {
  pipesCont.innerHTML = '';
  pipes = [];
  score = 0;
  frames = 0;
  birdY = height / 2 - 20;
  birdVel = 0;
  state = 'START';
  
  scoreEl.innerText = '0';
  scoreEl.style.display = 'block';
  document.getElementById("game-over-screen").style.display = 'none';
  document.getElementById("game-over-screen").classList.remove('show');
  
  // Show Start Msg
  document.getElementById("startMsg").style.display = 'block';
  
  birdEl.style.transition = 'none';
  birdEl.style.transform = `translate(${BIRD_X}px, ${birdY}px)`;
  birdEl.style.backgroundImage = `url(${assets.bird1})`;
};

/* --- SOUND ENGINE --- */
const ctx = new (window.AudioContext || window.webkitAudioContext)();
function playSound(type) {
  if (ctx.state === 'suspended') ctx.resume();
  
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.connect(gain);
  gain.connect(ctx.destination);

  if (type === 'flap') {
    osc.frequency.setValueAtTime(400, ctx.currentTime);
    osc.type = 'triangle';
    gain.gain.setValueAtTime(0.1, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
    osc.start(); 
    osc.stop(ctx.currentTime + 0.1);
  } else if (type === 'point') {
    osc.frequency.setValueAtTime(1000, ctx.currentTime);
    osc.type = 'sine';
    gain.gain.setValueAtTime(0.1, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
    osc.start(); 
    osc.stop(ctx.currentTime + 0.15);
  } else if (type === 'hit') {
    osc.frequency.setValueAtTime(150, ctx.currentTime);
    osc.type = 'sawtooth';
    gain.gain.setValueAtTime(0.2, ctx.currentTime);
    gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.3);
    osc.start(); 
    osc.stop(ctx.currentTime + 0.3);
  }
}

/* --- INPUT HANDLING --- */
// Keyboard
window.addEventListener('keydown', e => { 
  if(e.code === 'Space') { 
    e.preventDefault(); 
    flap(); 
  } 
});

// Mouse (avoid triggering on button clicks)
container.addEventListener('mousedown', e => { 
  if (!e.target.closest('.play-btn') && !e.target.closest('.back-btn')) {
    flap(); 
  }
});

// Touch (FIX: Use separate handler for game container vs play button)
container.addEventListener('touchstart', e => { 
  // Don't trigger flap if touching a button
  if (!e.target.closest('.play-btn') && !e.target.closest('.back-btn')) {
    e.preventDefault(); 
    flap(); 
  }
}, {passive: false});

// Play button click handler (works for both mouse and touch)
document.getElementById('playBtn').addEventListener('click', (e) => {
  e.stopPropagation(); // Prevent event bubbling
  resetGame();
});

// Additional touch handler for play button to ensure it works on mobile
document.getElementById('playBtn').addEventListener('touchend', (e) => {
  e.preventDefault();
  e.stopPropagation();
  resetGame();
});

// START LOADING
preloadGame();
</script>

</body>
</html>

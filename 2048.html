<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>2048 ‚Äì WebArcade</title>

<style>
:root {
  --bg-base: #020617;
  --bg-card: #1e293b;
  --accent: #6366f1;
  --text-main: #f8fafc;
  --text-muted: #94a3b8;
}

* { margin:0; padding:0; box-sizing:border-box; font-family:"Segoe UI", sans-serif; }

body {
  min-height: 100vh;
  background-color: var(--bg-base);
  color: var(--text-main);
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 10px;
  overflow: hidden; 
  user-select: none;
}

/* BACKGROUND GRID ANIMATION */
.retro-bg {
  position: fixed; inset: 0; z-index: -1;
  background: 
    linear-gradient(transparent 95%, rgba(99, 102, 241, 0.1) 95%),
    linear-gradient(90deg, transparent 95%, rgba(99, 102, 241, 0.1) 95%);
  background-size: 40px 40px;
  transform: perspective(500px) rotateX(20deg);
  opacity: 0.4;
  pointer-events: none;
}

/* MAIN CONTAINER */
.scene {
  display: flex; gap: 20px;
  padding: 20px;
  border-radius: 20px;
  background: rgba(15, 23, 42, 0.85);
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: 0 20px 50px rgba(0,0,0,0.6);
  backdrop-filter: blur(10px);
  max-width: 800px;
  width: 100%;
  justify-content: center;
}

@media(max-width: 850px) {
  .scene { flex-direction: column; align-items: center; max-width: 450px; }
}

/* --- GAME SECTION --- */
.game-container {
  width: 100%;
  max-width: 360px; /* Locks width to prevent shifting */
}

/* TOP BAR (FIXED OVERLAP) */
.top-bar {
  display: flex; 
  flex-wrap: wrap; /* Allows wrapping if screen is tiny */
  justify-content: space-between; 
  align-items: center;
  margin-bottom: 16px;
  gap: 10px;
}

.header-row {
  display: flex; justify-content: space-between; width: 100%; align-items: center;
}

.back-btn {
  background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
  color: var(--text-muted); padding: 6px 12px;
  cursor: pointer; font-size: 13px; font-weight: 600;
  border-radius: 8px; text-decoration: none;
}
.back-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }

.title {
  font-size: 28px; font-weight: 800;
  color: var(--text-main);
  text-shadow: 0 0 15px rgba(99,102,241,0.5);
}

.score-box {
  display: flex; gap: 8px; margin-top: 5px; width: 100%;
}
.score-card {
  flex: 1;
  background: #0f172a;
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 8px;
  padding: 8px;
  text-align: center;
}
.score-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
.score-val { font-size: 16px; font-weight: bold; color: #fff; }

/* BOARD (STABLE) */
.board-bg {
  background: #0f172a;
  padding: 10px; border-radius: 10px;
  width: 340px; height: 340px;
  border: 2px solid rgba(255,255,255,0.05);
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  grid-template-rows: repeat(4, 1fr);
  gap: 10px;
  touch-action: none; /* Critical for swipe */
}

/* Mobile Adjustment */
@media(max-width: 360px) {
  .board-bg { width: 300px; height: 300px; gap: 8px; padding: 8px; }
}

/* TILES */
.cell {
  width: 100%; height: 100%;
  border-radius: 6px;
  display: flex; align-items: center; justify-content: center;
  font-size: 28px; font-weight: bold;
  background: rgba(255,255,255,0.03); /* Empty cell color */
  transition: transform 0.1s, background 0.15s;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,0.05); /* Subtle inner border */
}

/* POP ANIMATION */
.pop { animation: pop 0.2s ease-in-out; }
@keyframes pop {
  0% { transform: scale(1); }
  50% { transform: scale(1.15); }
  100% { transform: scale(1); }
}

/* TILE COLORS (Vibrant & Neon) */
.t-2 { background: #e2e8f0; color: #334155; box-shadow: 0 2px 0 #cbd5e1; }
.t-4 { background: #fef08a; color: #854d0e; box-shadow: 0 2px 0 #fde047; }
.t-8 { background: #f97316; color: white; box-shadow: 0 2px 0 #ea580c; }
.t-16 { background: #ef4444; color: white; box-shadow: 0 2px 0 #dc2626; }
.t-32 { background: #ec4899; color: white; box-shadow: 0 2px 0 #db2777; }
.t-64 { background: #a855f7; color: white; box-shadow: 0 2px 0 #9333ea; }
.t-128 { background: #6366f1; color: white; box-shadow: 0 0 10px #6366f1; font-size: 24px; }
.t-256 { background: #3b82f6; color: white; box-shadow: 0 0 15px #3b82f6; font-size: 24px; }
.t-512 { background: #14b8a6; color: white; box-shadow: 0 0 20px #14b8a6; font-size: 24px; }
.t-1024 { background: #22c55e; color: white; box-shadow: 0 0 25px #22c55e; font-size: 20px; }
.t-2048 { background: #eab308; color: white; box-shadow: 0 0 30px #eab308; font-size: 20px; }

/* LEADERBOARD */
.leaderboard {
  width: 100%;
  background: rgba(30, 41, 59, 0.5);
  border-radius: 12px; padding: 15px;
  border: 1px solid rgba(255,255,255,0.05);
}
.leaderboard h3 { font-size: 16px; margin-bottom: 12px; color: var(--accent); text-align: center; }
.entry {
  display: flex; justify-content: space-between;
  padding: 8px 10px; 
  background: rgba(0,0,0,0.2);
  margin-bottom: 6px;
  border-radius: 6px;
  font-size: 13px;
}
.rank { font-weight: bold; color: #fbbf24; margin-right: 8px; }
</style>
</head>

<body>

<div class="retro-bg"></div>

<div class="scene">

  <div class="game-container">
    <div class="top-bar">
      <div class="header-row">
        <a href="blog.html" class="back-btn">‚Üê Back</a>
        <div class="title">2048</div>
        <div style="width: 50px;"></div> </div>
      
      <div class="score-box">
        <div class="score-card">
          <div class="score-label">Score</div>
          <div class="score-val" id="score">0</div>
        </div>
        <div class="score-card">
          <div class="score-label">Best</div>
          <div class="score-val" id="best">0</div>
        </div>
      </div>
    </div>
    
    <div class="board-bg" id="board">
      </div>
    
    <div style="text-align:center; font-size:12px; color:#64748b; margin-top:15px;">
      Use Arrow Keys or Swipe
    </div>
  </div>

  <div class="leaderboard">
    <h3>üèÜ Top Players</h3>
    <div id="leaderboard">Loading...</div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyCzomf89xZhgcPsfYXKsYspCt-CiUVzjBA",
  authDomain: "webarcade-d4c3d.firebaseapp.com",
  projectId: "webarcade-d4c3d"
});

const auth = getAuth(app);
const db = getFirestore(app);

let user = null;
let board = [];
let score = 0;
let best = 0;

const boardEl = document.getElementById("board");
const scoreEl = document.getElementById("score");
const bestEl = document.getElementById("best");
const lbEl = document.getElementById("leaderboard");

/* --- INITIALIZATION --- */
onAuthStateChanged(auth, async (u) => {
  user = u;
  if(user) {
    try {
      const s = await getDoc(doc(db, "users", user.uid));
      if(s.exists()) best = s.data().best2048 || 0;
    } catch(e){}
  } else {
    best = Number(localStorage.getItem("best2048")||0);
  }
  updateUI();
  loadLeaderboard();
});

/* --- GAME LOGIC --- */
function initGame() {
  board = Array.from({length:4}, () => Array(4).fill(0));
  score = 0;
  addRandom(); addRandom();
  drawBoard();
}

function drawBoard() {
  boardEl.innerHTML = "";
  board.forEach((row, r) => {
    row.forEach((val, c) => {
      const cell = document.createElement("div");
      cell.className = "cell";
      if(val > 0) {
        cell.textContent = val;
        cell.classList.add(`t-${val}`);
        // Add pop class for animation (handled by logic below mostly, simple re-render here)
      }
      boardEl.appendChild(cell);
    });
  });
  updateUI();
}

function updateUI() {
  scoreEl.textContent = score;
  bestEl.textContent = best;
}

function addRandom() {
  let empty = [];
  board.forEach((r, i) => r.forEach((v, j) => { if(v===0) empty.push({x:i, y:j}) }));
  if(empty.length === 0) return;
  let spot = empty[Math.floor(Math.random() * empty.length)];
  board[spot.x][spot.y] = Math.random() > 0.9 ? 4 : 2;
  
  // Quick hack to animate the specific new cell
  // In a full React/Vue app we would track IDs, but here re-draw works fast enough
}

function slide(row) {
  let arr = row.filter(v => v);
  for(let i=0; i<arr.length-1; i++){
    if(arr[i] === arr[i+1]){
      arr[i] *= 2; score += arr[i]; arr[i+1] = 0;
    }
  }
  arr = arr.filter(v => v);
  while(arr.length < 4) arr.push(0);
  return arr;
}

function move(dir) {
  let oldStr = JSON.stringify(board);
  
  if(dir === 'left') board = board.map(r => slide(r));
  else if(dir === 'right') board = board.map(r => slide(r.reverse()).reverse());
  else if(dir === 'up') {
    for(let c=0; c<4; c++) {
      let col = [board[0][c], board[1][c], board[2][c], board[3][c]];
      col = slide(col);
      for(let r=0; r<4; r++) board[r][c] = col[r];
    }
  }
  else if(dir === 'down') {
    for(let c=0; c<4; c++) {
      let col = [board[0][c], board[1][c], board[2][c], board[3][c]];
      col = slide(col.reverse()).reverse();
      for(let r=0; r<4; r++) board[r][c] = col[r];
    }
  }

  if(JSON.stringify(board) !== oldStr) {
    addRandom();
    drawBoard();
    
    // Save High Score
    if(score > best) {
      best = score;
      localStorage.setItem("best2048", best);
      if(user) setDoc(doc(db,"users",user.uid), { best2048: best }, { merge: true }).then(loadLeaderboard);
    }
  }
}

/* --- LEADERBOARD --- */
async function loadLeaderboard() {
  lbEl.innerHTML = "Loading...";
  try {
    const s = await getDocs(collection(db, "users"));
    let d = [];
    s.forEach(doc => {
       const dd = doc.data();
       if(dd.best2048 > 0) d.push({n: dd.username || "Anon", s: dd.best2048});
    });
    d.sort((a,b) => b.s - a.s);
    
    lbEl.innerHTML = "";
    if(d.length === 0) lbEl.innerHTML = "<div style='text-align:center;font-size:12px'>No scores yet</div>";
    
    d.slice(0,5).forEach((p, i) => {
      const div = document.createElement("div");
      div.className = "entry";
      div.innerHTML = `<div><span class="rank">#${i+1}</span> ${p.n.substring(0,10)}</div> <div>${p.s}</div>`;
      lbEl.appendChild(div);
    });
  } catch(e){ console.log(e); lbEl.innerHTML = "Offline"; }
}

/* --- CONTROLS --- */
document.addEventListener("keydown", e => {
  if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)) {
    e.preventDefault();
    move(e.key.replace("Arrow","").toLowerCase());
  }
});

let tsX, tsY;
boardEl.addEventListener("touchstart", e => { tsX=e.touches[0].clientX; tsY=e.touches[0].clientY; e.preventDefault(); }, {passive:false});
boardEl.addEventListener("touchend", e => {
  let dX = e.changedTouches[0].clientX - tsX;
  let dY = e.changedTouches[0].clientY - tsY;
  if(Math.abs(dX) > Math.abs(dY) && Math.abs(dX)>30) move(dX>0?"right":"left");
  else if(Math.abs(dY) > 30) move(dY>0?"down":"up");
}, {passive:false});

initGame();
</script>

</body>
</html>

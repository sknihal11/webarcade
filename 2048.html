<script>
const grid = document.getElementById("grid");
const scoreEl = document.getElementById("score");

let board = Array(16).fill(0);
let score = 0;

/* INIT */
function init() {
  addTile();
  addTile();
  render();
}

/* RENDER */
function render() {
  grid.innerHTML = "";
  board.forEach(v => {
    const d = document.createElement("div");
    d.className = "tile";
    if (v) {
      d.textContent = v;
      d.dataset.v = v;
    }
    grid.appendChild(d);
  });
  scoreEl.textContent = score;
}

/* UTIL */
function addTile() {
  const empty = board
    .map((v, i) => v === 0 ? i : null)
    .filter(v => v !== null);

  if (!empty.length) return;

  board[empty[Math.floor(Math.random() * empty.length)]] =
    Math.random() > 0.9 ? 4 : 2;
}

function slide(arr) {
  arr = arr.filter(v => v);
  for (let i = 0; i < arr.length - 1; i++) {
    if (arr[i] === arr[i + 1]) {
      arr[i] *= 2;
      score += arr[i];
      arr[i + 1] = 0;
    }
  }
  return arr.filter(v => v);
}

/* MOVES */
function moveLeft() {
  for (let r = 0; r < 4; r++) {
    let row = board.slice(r * 4, r * 4 + 4);
    let newRow = slide(row);
    while (newRow.length < 4) newRow.push(0);
    board.splice(r * 4, 4, ...newRow);
  }
  postMove();
}

function moveRight() {
  for (let r = 0; r < 4; r++) {
    let row = board.slice(r * 4, r * 4 + 4).reverse();
    let newRow = slide(row);
    while (newRow.length < 4) newRow.push(0);
    board.splice(r * 4, 4, ...newRow.reverse());
  }
  postMove();
}

function moveUp() {
  for (let c = 0; c < 4; c++) {
    let col = [
      board[c],
      board[c + 4],
      board[c + 8],
      board[c + 12]
    ];
    let newCol = slide(col);
    while (newCol.length < 4) newCol.push(0);
    for (let r = 0; r < 4; r++) {
      board[c + r * 4] = newCol[r];
    }
  }
  postMove();
}

function moveDown() {
  for (let c = 0; c < 4; c++) {
    let col = [
      board[c],
      board[c + 4],
      board[c + 8],
      board[c + 12]
    ].reverse();
    let newCol = slide(col);
    while (newCol.length < 4) newCol.push(0);
    newCol.reverse();
    for (let r = 0; r < 4; r++) {
      board[c + r * 4] = newCol[r];
    }
  }
  postMove();
}

/* AFTER MOVE */
function postMove() {
  addTile();
  render();
}

/* KEYBOARD */
document.addEventListener("keydown", e => {
  if (e.key === "ArrowLeft") moveLeft();
  if (e.key === "ArrowRight") moveRight();
  if (e.key === "ArrowUp") moveUp();
  if (e.key === "ArrowDown") moveDown();
});

/* RESET (optional button) */
function reset() {
  board = Array(16).fill(0);
  score = 0;
  init();
}

init();
</script>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>WebArcade</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">

<style>
:root {
  --black: #030507;
  --black-2: #0a0f0d;
  --green: #00ff87;
  --green-dim: #00c96a;
  --green-glow: rgba(0, 255, 135, 0.25);
  --green-glow-strong: rgba(0, 255, 135, 0.5);
  --glass: rgba(0, 255, 135, 0.04);
  --glass-border: rgba(0, 255, 135, 0.12);
  --text: #e8fff5;
  --text-muted: rgba(232, 255, 245, 0.45);
  --font-display: 'Orbitron', sans-serif;
  --font-mono: 'Share Tech Mono', monospace;
  --font-body: 'Inter', sans-serif;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html { scroll-behavior: smooth; }

body {
  font-family: var(--font-body);
  background: var(--black);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
  cursor: crosshair;
}

/* â”€â”€ ANIMATED BACKGROUND â”€â”€ */
.bg-canvas {
  position: fixed;
  inset: 0;
  z-index: 0;
  pointer-events: none;
  overflow: hidden;
}

.bg-canvas::before {
  content: '';
  position: absolute;
  inset: 0;
  background:
    radial-gradient(ellipse 80% 50% at 50% -10%, rgba(0, 255, 135, 0.08) 0%, transparent 60%),
    radial-gradient(ellipse 40% 40% at 80% 80%, rgba(0, 255, 135, 0.04) 0%, transparent 60%);
}

/* Scanlines */
.bg-canvas::after {
  content: '';
  position: absolute;
  inset: 0;
  background: repeating-linear-gradient(
    0deg,
    transparent,
    transparent 2px,
    rgba(0, 255, 135, 0.015) 2px,
    rgba(0, 255, 135, 0.015) 4px
  );
  animation: scanSlide 8s linear infinite;
  pointer-events: none;
}

@keyframes scanSlide {
  0% { transform: translateY(0); }
  100% { transform: translateY(40px); }
}

/* Grid */
.grid-overlay {
  position: fixed;
  inset: 0;
  z-index: 0;
  pointer-events: none;
  background-image:
    linear-gradient(rgba(0,255,135,0.04) 1px, transparent 1px),
    linear-gradient(90deg, rgba(0,255,135,0.04) 1px, transparent 1px);
  background-size: 60px 60px;
  mask-image: radial-gradient(ellipse 80% 80% at 50% 50%, black 40%, transparent 100%);
}

/* Animated particles */
.particle {
  position: fixed;
  width: 2px;
  height: 2px;
  border-radius: 50%;
  background: var(--green);
  box-shadow: 0 0 6px var(--green);
  pointer-events: none;
  z-index: 0;
  animation: floatParticle linear infinite;
  opacity: 0;
}

@keyframes floatParticle {
  0%   { transform: translateY(100vh) translateX(0); opacity: 0; }
  10%  { opacity: 0.8; }
  90%  { opacity: 0.4; }
  100% { transform: translateY(-10vh) translateX(20px); opacity: 0; }
}

/* Corner HUD decorations */
.hud-corner {
  position: fixed;
  width: 60px;
  height: 60px;
  z-index: 1;
  pointer-events: none;
}
.hud-corner.tl { top: 16px; left: 16px; border-top: 1px solid var(--green); border-left: 1px solid var(--green); }
.hud-corner.tr { top: 16px; right: 16px; border-top: 1px solid var(--green); border-right: 1px solid var(--green); }
.hud-corner.bl { bottom: 16px; left: 16px; border-bottom: 1px solid var(--green); border-left: 1px solid var(--green); }
.hud-corner.br { bottom: 16px; right: 16px; border-bottom: 1px solid var(--green); border-right: 1px solid var(--green); }

/* â”€â”€ HEADER â”€â”€ */
header {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 100;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px 5%;
  background: rgba(3, 5, 7, 0.6);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--glass-border);
}

.logo {
  font-family: var(--font-display);
  font-weight: 900;
  font-size: clamp(1rem, 2.5vw, 1.3rem);
  letter-spacing: 0.15em;
  color: var(--green);
  text-shadow: 0 0 20px var(--green-glow-strong), 0 0 40px rgba(0,255,135,0.2);
  text-decoration: none;
  position: relative;
}

.logo::after {
  content: 'â–®';
  margin-left: 6px;
  animation: blink 1s step-end infinite;
  font-size: 0.7em;
  opacity: 0.8;
}

@keyframes blink {
  0%, 100% { opacity: 0.8; }
  50% { opacity: 0; }
}

.header-right {
  display: flex;
  align-items: center;
  gap: 16px;
}

.nav-status {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-muted);
  letter-spacing: 0.1em;
}

.btn {
  font-family: var(--font-mono);
  font-size: 13px;
  letter-spacing: 0.1em;
  padding: 10px 28px;
  border: 1px solid var(--green);
  border-radius: 2px;
  background: transparent;
  color: var(--green);
  cursor: pointer;
  position: relative;
  overflow: hidden;
  transition: color 0.3s, box-shadow 0.3s;
  text-transform: uppercase;
}

.btn::before {
  content: '';
  position: absolute;
  inset: 0;
  background: var(--green);
  transform: translateX(-101%);
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  z-index: -1;
}

.btn:hover { color: var(--black); box-shadow: 0 0 20px var(--green-glow-strong); }
.btn:hover::before { transform: translateX(0); }

.btn-danger {
  border-color: rgba(255, 60, 60, 0.6);
  color: rgba(255, 100, 100, 0.9);
}
.btn-danger::before { background: rgba(255, 60, 60, 0.8); }
.btn-danger:hover { color: white; box-shadow: 0 0 20px rgba(255,60,60,0.4); }

.user-info { display: none; align-items: center; gap: 14px; }
.user-info.visible { display: flex; }

.username-badge {
  font-family: var(--font-mono);
  font-size: 13px;
  color: var(--green);
  letter-spacing: 0.05em;
}
.username-badge::before { content: '> '; opacity: 0.5; }

.online-dot {
  width: 7px; height: 7px; border-radius: 50%;
  background: var(--green);
  box-shadow: 0 0 8px var(--green);
  animation: pulse 2s ease-in-out infinite;
}
@keyframes pulse { 0%,100%{ box-shadow: 0 0 8px var(--green); } 50%{ box-shadow: 0 0 16px var(--green), 0 0 30px var(--green-glow); } }

/* â”€â”€ HERO â”€â”€ */
.hero {
  position: relative;
  z-index: 1;
  min-height: 100vh;
  display: flex;
  align-items: center;
  padding: 120px 8% 80px;
}

.hero-content {
  max-width: 780px;
}

.hero-label {
  font-family: var(--font-mono);
  font-size: 12px;
  letter-spacing: 0.3em;
  color: var(--green);
  margin-bottom: 24px;
  opacity: 0;
  animation: fadeUp 0.8s 0.2s ease forwards;
}

.hero-label::before { content: '// '; opacity: 0.5; }

.hero-title {
  font-family: var(--font-display);
  font-weight: 900;
  font-size: clamp(3rem, 9vw, 7rem);
  line-height: 0.95;
  letter-spacing: -0.02em;
  color: var(--text);
  opacity: 0;
  animation: fadeUp 0.8s 0.4s ease forwards;
}

.hero-title .accent {
  color: var(--green);
  text-shadow: 0 0 30px var(--green-glow-strong), 0 0 60px rgba(0,255,135,0.15);
  display: block;
}

.hero-sub {
  margin-top: 28px;
  font-size: clamp(0.95rem, 1.8vw, 1.1rem);
  color: var(--text-muted);
  font-weight: 300;
  line-height: 1.8;
  max-width: 520px;
  opacity: 0;
  animation: fadeUp 0.8s 0.6s ease forwards;
}

.hero-actions {
  margin-top: 48px;
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
  opacity: 0;
  animation: fadeUp 0.8s 0.8s ease forwards;
}

.btn-primary {
  font-family: var(--font-mono);
  font-size: 13px;
  letter-spacing: 0.15em;
  padding: 16px 40px;
  background: var(--green);
  color: var(--black);
  border: none;
  border-radius: 2px;
  cursor: pointer;
  font-weight: 700;
  text-transform: uppercase;
  position: relative;
  overflow: hidden;
  transition: box-shadow 0.3s, transform 0.2s;
  box-shadow: 0 0 30px var(--green-glow), 0 4px 20px rgba(0,255,135,0.3);
}

.btn-primary::after {
  content: '';
  position: absolute;
  top: -50%; left: -50%;
  width: 200%; height: 200%;
  background: linear-gradient(transparent, rgba(255,255,255,0.15), transparent);
  transform: rotate(30deg) translateX(-100%);
  transition: transform 0.6s;
}

.btn-primary:hover { box-shadow: 0 0 50px var(--green-glow-strong), 0 8px 30px rgba(0,255,135,0.4); transform: translateY(-2px); }
.btn-primary:hover::after { transform: rotate(30deg) translateX(100%); }

.hero-stats {
  position: absolute;
  right: 8%;
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  flex-direction: column;
  gap: 32px;
  opacity: 0;
  animation: fadeLeft 0.8s 1s ease forwards;
}

@media (max-width: 900px) {
  .hero-stats { display: none; }
}

.stat-card {
  background: var(--glass);
  border: 1px solid var(--glass-border);
  border-radius: 4px;
  padding: 20px 28px;
  backdrop-filter: blur(10px);
  text-align: right;
  min-width: 160px;
  position: relative;
  overflow: hidden;
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--green), transparent);
}

.stat-num {
  font-family: var(--font-display);
  font-size: 2rem;
  font-weight: 700;
  color: var(--green);
  text-shadow: 0 0 20px var(--green-glow);
}

.stat-label {
  font-family: var(--font-mono);
  font-size: 10px;
  letter-spacing: 0.2em;
  color: var(--text-muted);
  margin-top: 4px;
  text-transform: uppercase;
}

/* â”€â”€ FULL-SCREEN MODAL â”€â”€ */
.modal-backdrop {
  position: fixed;
  inset: 0;
  z-index: 200;
  display: none;
  opacity: 0;
  transition: opacity 0.4s;
}

.modal-backdrop.open {
  display: flex;
  opacity: 1;
}

.modal-bg {
  position: absolute;
  inset: 0;
  background: rgba(3, 5, 7, 0.97);
  backdrop-filter: blur(20px);
}

.modal-panel {
  position: relative;
  z-index: 1;
  width: 100%;
  display: grid;
  grid-template-columns: 1fr 1fr;
  min-height: 100vh;
}

@media (max-width: 768px) {
  .modal-panel { grid-template-columns: 1fr; }
  .modal-left { display: none; }
}

/* Left decorative side */
.modal-left {
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 60px;
  border-right: 1px solid var(--glass-border);
  overflow: hidden;
}

.modal-left-bg {
  position: absolute;
  inset: 0;
  background:
    radial-gradient(ellipse 80% 60% at 50% 50%, rgba(0,255,135,0.06) 0%, transparent 70%);
}

.modal-left-grid {
  position: absolute;
  inset: 0;
  background-image:
    linear-gradient(rgba(0,255,135,0.06) 1px, transparent 1px),
    linear-gradient(90deg, rgba(0,255,135,0.06) 1px, transparent 1px);
  background-size: 40px 40px;
}

.modal-art {
  position: relative;
  z-index: 1;
  text-align: center;
}

.modal-art-icon {
  font-size: 80px;
  animation: floatIcon 4s ease-in-out infinite;
  filter: drop-shadow(0 0 30px var(--green-glow-strong));
  display: block;
  margin-bottom: 32px;
}

@keyframes floatIcon {
  0%, 100% { transform: translateY(0) rotate(-2deg); }
  50% { transform: translateY(-16px) rotate(2deg); }
}

.modal-art h2 {
  font-family: var(--font-display);
  font-size: 2.5rem;
  font-weight: 900;
  color: var(--green);
  text-shadow: 0 0 30px var(--green-glow-strong);
  margin-bottom: 16px;
}

.modal-art p {
  font-family: var(--font-mono);
  font-size: 13px;
  color: var(--text-muted);
  line-height: 1.8;
  letter-spacing: 0.05em;
}

.modal-feature-list {
  margin-top: 40px;
  list-style: none;
  text-align: left;
}

.modal-feature-list li {
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--text-muted);
  padding: 8px 0;
  letter-spacing: 0.05em;
  border-bottom: 1px solid rgba(0,255,135,0.06);
  display: flex;
  align-items: center;
  gap: 10px;
}

.modal-feature-list li::before {
  content: 'âœ“';
  color: var(--green);
  font-size: 14px;
  flex-shrink: 0;
}

/* Right form side */
.modal-right {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 60px 10%;
  position: relative;
}

.close-btn {
  position: absolute;
  top: 24px;
  right: 32px;
  background: none;
  border: 1px solid var(--glass-border);
  color: var(--text-muted);
  width: 40px;
  height: 40px;
  border-radius: 2px;
  font-size: 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: border-color 0.2s, color 0.2s;
  font-family: var(--font-mono);
}

.close-btn:hover { border-color: var(--green); color: var(--green); }

.form-wrap {
  width: 100%;
  max-width: 400px;
}

.form-tag {
  font-family: var(--font-mono);
  font-size: 11px;
  letter-spacing: 0.3em;
  color: var(--green);
  text-transform: uppercase;
  margin-bottom: 12px;
  opacity: 0.7;
}

.form-title {
  font-family: var(--font-display);
  font-size: clamp(1.8rem, 4vw, 2.5rem);
  font-weight: 700;
  color: var(--text);
  margin-bottom: 40px;
  letter-spacing: 0.02em;
}

.field-group {
  margin-bottom: 20px;
  position: relative;
}

.field-label {
  font-family: var(--font-mono);
  font-size: 11px;
  letter-spacing: 0.2em;
  color: var(--text-muted);
  text-transform: uppercase;
  display: block;
  margin-bottom: 8px;
}

input {
  width: 100%;
  padding: 14px 16px;
  background: rgba(0,255,135,0.03);
  border: 1px solid rgba(0,255,135,0.15);
  border-radius: 2px;
  color: var(--text);
  font-family: var(--font-mono);
  font-size: 14px;
  outline: none;
  transition: border-color 0.3s, background 0.3s, box-shadow 0.3s;
  letter-spacing: 0.05em;
}

input::placeholder { color: rgba(232,255,245,0.2); }

input:focus {
  border-color: var(--green);
  background: rgba(0,255,135,0.06);
  box-shadow: 0 0 0 3px rgba(0,255,135,0.1), inset 0 0 20px rgba(0,255,135,0.03);
}

input.valid { border-color: var(--green-dim); }
input.invalid { border-color: rgba(255,80,80,0.7); background: rgba(255,80,80,0.03); }
input.warning { border-color: rgba(255,200,0,0.7); }

.field-error {
  font-family: var(--font-mono);
  font-size: 11px;
  color: rgba(255,100,100,0.9);
  margin-top: 6px;
  letter-spacing: 0.05em;
  display: none;
}
.field-error.show { display: block; }

.field-warning {
  font-family: var(--font-mono);
  font-size: 11px;
  color: rgba(255,200,0,0.9);
  margin-top: 6px;
  letter-spacing: 0.05em;
  display: none;
}
.field-warning.show { display: block; }

.strength-bar {
  height: 2px;
  background: rgba(255,255,255,0.05);
  margin-top: 8px;
  border-radius: 1px;
  overflow: hidden;
  display: none;
}

.strength-bar.visible { display: block; }

.strength-fill {
  height: 100%;
  width: 0%;
  transition: width 0.3s, background 0.3s;
}
.strength-fill.weak   { width: 33%; background: rgba(255,80,80,0.8); }
.strength-fill.medium { width: 66%; background: rgba(255,200,0,0.8); }
.strength-fill.strong { width: 100%; background: var(--green); }

.hidden { display: none !important; }

.submit-btn {
  width: 100%;
  padding: 16px;
  background: var(--green);
  color: var(--black);
  border: none;
  border-radius: 2px;
  font-family: var(--font-display);
  font-size: 14px;
  font-weight: 700;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  cursor: pointer;
  margin-top: 28px;
  position: relative;
  overflow: hidden;
  transition: box-shadow 0.3s, transform 0.2s, opacity 0.2s;
  box-shadow: 0 0 30px var(--green-glow);
}

.submit-btn:hover:not(:disabled) {
  box-shadow: 0 0 50px var(--green-glow-strong);
  transform: translateY(-1px);
}

.submit-btn:disabled { opacity: 0.4; cursor: not-allowed; }

.submit-btn .btn-shine {
  position: absolute;
  top: 0; left: -100%;
  width: 60%; height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
  transition: left 0.6s;
}
.submit-btn:hover:not(:disabled) .btn-shine { left: 150%; }

.status-msg {
  margin-top: 16px;
  text-align: center;
  font-family: var(--font-mono);
  font-size: 12px;
  min-height: 1.5em;
  letter-spacing: 0.05em;
}
.status-msg.error { color: rgba(255,100,100,0.9); }
.status-msg.success { color: var(--green); }

.form-switch {
  margin-top: 28px;
  text-align: center;
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--text-muted);
  letter-spacing: 0.05em;
}

.form-switch a {
  color: var(--green);
  text-decoration: none;
  cursor: pointer;
  border-bottom: 1px solid rgba(0,255,135,0.3);
  padding-bottom: 1px;
  transition: border-color 0.2s;
}

.form-switch a:hover { border-color: var(--green); }

.info-hint {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-muted);
  margin-top: 6px;
  letter-spacing: 0.05em;
  display: none;
}
.info-hint.visible { display: block; }

/* â”€â”€ KEYFRAMES â”€â”€ */
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(24px); }
  to   { opacity: 1; transform: translateY(0); }
}

@keyframes fadeLeft {
  from { opacity: 0; transform: translateX(24px); }
  to   { opacity: 1; transform: translateX(0); }
}

/* Modal entrance */
.modal-backdrop.open .modal-panel {
  animation: modalIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
}

@keyframes modalIn {
  from { opacity: 0; transform: scale(0.97); }
  to   { opacity: 1; transform: scale(1); }
}

/* Typing cursor for status */
.typing::after {
  content: '_';
  animation: blink 0.8s step-end infinite;
}
</style>
</head>
<body>

<!-- Background layers -->
<div class="bg-canvas"></div>
<div class="grid-overlay"></div>

<!-- HUD corners -->
<div class="hud-corner tl"></div>
<div class="hud-corner tr"></div>
<div class="hud-corner bl"></div>
<div class="hud-corner br"></div>

<!-- â”€â”€ HEADER â”€â”€ -->
<header>
  <span class="logo">WebArcade</span>
  <div class="header-right">
    <span class="nav-status" id="navStatus">SYS::ONLINE</span>
    <div id="loginBtn">
      <button class="btn" onclick="openModal()">ENTER ARCADE</button>
    </div>
    <div class="user-info" id="userInfo">
      <div class="online-dot"></div>
      <span class="username-badge" id="usernameDisplay"></span>
      <button class="btn btn-danger" onclick="logout()">LOGOUT</button>
    </div>
  </div>
</header>

<!-- â”€â”€ HERO â”€â”€ -->
<section class="hero">
  <div class="hero-content">
    <p class="hero-label">SYSTEM READY // v2.0.1</p>
    <h1 class="hero-title">
      PLAY.<br>COMPETE.<br>
      <span class="accent">DOMINATE.</span>
    </h1>
    <p class="hero-sub">
      A futuristic retro arcade dashboard â€” save scores, track rivals, and launch into games instantly. Your session. Your leaderboard.
    </p>
    <div class="hero-actions">
      <button class="btn-primary" onclick="openModal()">
        <span>LAUNCH ARCADE</span>
      </button>
      <button class="btn" style="padding: 16px 32px;">LEARN MORE</button>
    </div>
  </div>

  <div class="hero-stats">
    <div class="stat-card">
      <div class="stat-num" id="counter1">0</div>
      <div class="stat-label">Players Online</div>
    </div>
    <div class="stat-card">
      <div class="stat-num" id="counter2">0</div>
      <div class="stat-label">Games Played</div>
    </div>
    <div class="stat-card">
      <div class="stat-num" id="counter3">0</div>
      <div class="stat-label">High Scores</div>
    </div>
  </div>
</section>

<!-- â”€â”€ FULL-SCREEN MODAL â”€â”€ -->
<div class="modal-backdrop" id="modal">
  <div class="modal-bg" onclick="closeModalOutside(event)"></div>
  <div class="modal-panel">

    <!-- Left visual -->
    <div class="modal-left">
      <div class="modal-left-bg"></div>
      <div class="modal-left-grid"></div>
      <div class="modal-art">
        <span class="modal-art-icon">ðŸŽ®</span>
        <h2>WEBARCADE</h2>
        <p>Your retro-futuristic<br>gaming hub awaits.</p>
        <ul class="modal-feature-list">
          <li>Persistent score tracking</li>
          <li>Cross-session leaderboards</li>
          <li>Secure session management</li>
          <li>Multi-device support</li>
          <li>Breach-checked passwords</li>
        </ul>
      </div>
    </div>

    <!-- Right form -->
    <div class="modal-right">
      <button class="close-btn" onclick="closeModal()">Ã—</button>
      <div class="form-wrap">
        <p class="form-tag" id="formTag">AUTHENTICATION</p>
        <h3 class="form-title" id="modalTitle">Login</h3>

        <!-- Username (signup only) -->
        <div class="field-group" id="usernameGroup" style="display:none;">
          <label class="field-label" for="username">Username</label>
          <input id="username" type="text" placeholder="3â€“20 chars, letters, numbers, _" autocomplete="off" maxlength="20">
          <div class="field-error" id="usernameError"></div>
        </div>

        <!-- Email -->
        <div class="field-group">
          <label class="field-label" for="email">Email Address</label>
          <input id="email" type="email" placeholder="you@example.com" autocomplete="email">
          <div class="field-error" id="emailError"></div>
        </div>

        <!-- Password -->
        <div class="field-group">
          <label class="field-label" for="password">Password</label>
          <input id="password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
          <div class="strength-bar" id="strengthBar">
            <div class="strength-fill" id="strengthFill"></div>
          </div>
          <div class="field-error" id="passwordError"></div>
          <div class="field-warning" id="passwordWarning"></div>
          <div class="info-hint" id="breachInfo">âš¡ Passwords checked against breach databases</div>
        </div>

        <button class="submit-btn" id="actionBtn" onclick="handleAction()">
          <span class="btn-shine"></span>
          <span id="btnText">LOGIN</span>
        </button>

        <div class="status-msg" id="status"></div>

        <div class="form-switch">
          <span id="switchText">New player? </span>
          <a onclick="toggleMode()">Create account</a>
        </div>
      </div>
    </div>

  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import {
  getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword,
  updateProfile, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import {
  getFirestore, doc, setDoc, getDoc, updateDoc, collection, query,
  where, getDocs, arrayUnion, arrayRemove
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCzomf89xZhgcPsfYXKsYspCt-CiUVzjBA",
  authDomain: "webarcade-d4c3d.firebaseapp.com",
  projectId: "webarcade-d4c3d",
  storageBucket: "webarcade-d4c3d.firebasestorage.app",
  messagingSenderId: "918209461327",
  appId: "1:918209461327:web:bd9c1a2431f9b5c66ffe3a"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

setPersistence(auth, browserLocalPersistence);

let currentUser = null;
let currentDeviceId = null;
let isSigningUp = false;

function getDeviceId() {
  let id = localStorage.getItem('deviceId');
  if (!id) {
    id = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 15);
    localStorage.setItem('deviceId', id);
  }
  return id;
}

async function registerSession(userId, deviceId) {
  const ref = doc(db, "users", userId);
  const snap = await getDoc(ref);
  if (snap.exists()) {
    const data = snap.data();
    const sessions = data.activeSessions || [];
    const max = data.maxSessions || 2;
    if (!sessions.includes(deviceId)) {
      if (sessions.length >= max) throw new Error(`Session limit reached. Max ${max} devices. Logout from another device first.`);
      await updateDoc(ref, { activeSessions: arrayUnion(deviceId), lastActivity: new Date() });
    } else {
      await updateDoc(ref, { lastActivity: new Date() });
    }
  }
}

async function unregisterSession(userId, deviceId) {
  try {
    await updateDoc(doc(db, "users", userId), { activeSessions: arrayRemove(deviceId), currentGameSession: null });
  } catch (e) { console.error(e); }
}

async function checkPasswordBreach(password) {
  try {
    const buf = await crypto.subtle.digest('SHA-1', new TextEncoder().encode(password));
    const hex = Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('').toUpperCase();
    const res = await fetch(`https://api.pwnedpasswords.com/range/${hex.slice(0,5)}`);
    const lines = (await res.text()).split('\n');
    for (const line of lines) {
      const [s, c] = line.split(':');
      if (s === hex.slice(5)) return parseInt(c);
    }
    return 0;
  } catch { return 0; }
}

onAuthStateChanged(auth, async (user) => {
  if (user) {
    if (isSigningUp) return;
    try {
      currentUser = user;
      currentDeviceId = getDeviceId();
      await registerSession(user.uid, currentDeviceId);
      document.getElementById('loginBtn').style.display = 'none';
      document.getElementById('userInfo').classList.add('visible');
      const snap = await getDoc(doc(db, "users", user.uid));
      document.getElementById('usernameDisplay').textContent =
        snap.exists() ? (snap.data().username || user.displayName || 'PLAYER') : (user.displayName || 'PLAYER');
      window.location.href = "blog.html";
    } catch (err) {
      console.error(err);
      if (err.message.includes("Session limit")) { alert(err.message); await signOut(auth); }
    }
  } else {
    currentUser = null;
    document.getElementById('loginBtn').style.display = 'block';
    document.getElementById('userInfo').classList.remove('visible');
  }
});

window.logout = async () => {
  if (currentUser && currentDeviceId) await unregisterSession(currentUser.uid, currentDeviceId);
  await signOut(auth);
  location.reload();
};

// â”€â”€ FORM LOGIC â”€â”€
const inputs = {
  username: document.getElementById('username'),
  email: document.getElementById('email'),
  password: document.getElementById('password')
};
const errs = {
  username: document.getElementById('usernameError'),
  email: document.getElementById('emailError'),
  password: document.getElementById('passwordError')
};
const statusEl = document.getElementById('status');
const actionBtn = document.getElementById('actionBtn');
const btnText = document.getElementById('btnText');
const passwordWarning = document.getElementById('passwordWarning');
const strengthBar = document.getElementById('strengthBar');
const strengthFill = document.getElementById('strengthFill');
const breachInfo = document.getElementById('breachInfo');
let mode = 'login';

const validateUsername = u => {
  if (!u || u.length < 3) return "Username must be at least 3 characters";
  if (u.length > 20) return "Username must be less than 20 characters";
  if (!/^[a-zA-Z0-9_]+$/.test(u)) return "Letters, numbers, and underscores only";
  return null;
};
const validateEmail = e => {
  if (!e) return "Email is required";
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)) return "Invalid email format";
  const blocked = ['test.com','fake.com','example.com','tempmail.com','10minutemail.com','guerrillamail.com','mailinator.com'];
  if (blocked.includes(e.split('@')[1]?.toLowerCase())) return "Use a real email address";
  return null;
};
const validatePassword = p => {
  if (!p || p.length < 8) return "Minimum 8 characters required";
  if (!/[a-zA-Z]/.test(p)) return "Must contain letters";
  if (!/\d/.test(p)) return "Must contain at least one number";
  return null;
};
const calcStrength = p => {
  let s = 0;
  if (p.length >= 8) s++;
  if (p.length >= 12) s++;
  if (/[a-z]/.test(p) && /[A-Z]/.test(p)) s++;
  if (/\d/.test(p)) s++;
  if (/[^a-zA-Z0-9]/.test(p)) s++;
  return s;
};

function showError(f, m) { inputs[f].className = 'invalid'; errs[f].textContent = m; errs[f].classList.add('show'); }
function clearErr(f) { inputs[f].className = 'valid'; errs[f].classList.remove('show'); if(f==='password') passwordWarning.classList.remove('show'); }
function clearAll() { Object.keys(inputs).forEach(f => { inputs[f].className = ''; errs[f].classList.remove('show'); }); passwordWarning.classList.remove('show'); }

let utimer, etimer, ptimer, lastBreachPw = '';

inputs.username.addEventListener('input', async e => {
  if (mode !== 'signup') return;
  const v = e.target.value.trim();
  const err = validateUsername(v);
  if (err) { showError('username', err); return; }
  clearTimeout(utimer);
  utimer = setTimeout(async () => {
    const q = query(collection(db,"users"), where("usernameLower","==",v.toLowerCase()));
    const s = await getDocs(q);
    s.empty ? clearErr('username') : showError('username', 'Username already taken');
  }, 500);
});

inputs.email.addEventListener('input', e => {
  if (mode !== 'signup') return;
  const v = e.target.value.trim();
  const err = validateEmail(v);
  if (err) { showError('email', err); return; }
  clearErr('email');
});

inputs.password.addEventListener('input', async e => {
  if (mode !== 'signup') return;
  const p = e.target.value;
  const err = validatePassword(p);
  const s = calcStrength(p);
  strengthFill.className = 'strength-fill';
  if (s >= 4) strengthFill.classList.add('strong');
  else if (s >= 2) strengthFill.classList.add('medium');
  else if (p.length > 0) strengthFill.classList.add('weak');
  if (err) { showError('password', err); return; }
  clearErr('password');
  clearTimeout(ptimer);
  ptimer = setTimeout(async () => {
    if (p === lastBreachPw) return;
    lastBreachPw = p;
    const count = await checkPasswordBreach(p);
    if (count > 0) {
      inputs.password.className = 'warning';
      passwordWarning.textContent = `âš  Found in ${count.toLocaleString()} breaches â€” choose another`;
      passwordWarning.classList.add('show');
    }
  }, 1000);
});

window.openModal = () => {
  const m = document.getElementById('modal');
  m.style.display = 'flex';
  setTimeout(() => m.classList.add('open'), 10);
  statusEl.textContent = '';
  inputs.email.value = '';
  inputs.password.value = '';
  inputs.username.value = '';
  clearAll();
};

window.closeModal = () => {
  const m = document.getElementById('modal');
  m.classList.remove('open');
  setTimeout(() => { m.style.display = 'none'; }, 400);
};

window.closeModalOutside = e => { if (e.target.classList.contains('modal-bg')) closeModal(); };

window.toggleMode = () => {
  mode = mode === 'login' ? 'signup' : 'login';
  const isSignup = mode === 'signup';
  document.getElementById('modalTitle').textContent = isSignup ? 'Create Account' : 'Login';
  document.getElementById('switchText').textContent = isSignup ? 'Have an account? ' : 'New player? ';
  document.querySelector('.form-switch a').textContent = isSignup ? 'Login instead' : 'Create account';
  btnText.textContent = isSignup ? 'CREATE ACCOUNT' : 'LOGIN';
  document.getElementById('usernameGroup').style.display = isSignup ? 'block' : 'none';
  strengthBar.classList.toggle('visible', isSignup);
  breachInfo.classList.toggle('visible', isSignup);
  inputs.password.setAttribute('autocomplete', isSignup ? 'new-password' : 'current-password');
  clearAll();
  statusEl.textContent = '';
};

window.handleAction = async () => {
  const emailVal = inputs.email.value.trim();
  const passVal = inputs.password.value;
  const userVal = inputs.username.value.trim();
  clearAll(); statusEl.textContent = ''; statusEl.className = 'status-msg';

  if (!emailVal || !passVal) {
    statusEl.textContent = 'Please fill in all fields.'; statusEl.classList.add('error'); return;
  }

  try {
    if (mode === 'login') {
      statusEl.textContent = 'Authenticating...'; statusEl.classList.add('typing');
      actionBtn.disabled = true;
      await signInWithEmailAndPassword(auth, emailVal, passVal);
    } else {
      const ue = validateUsername(userVal);
      const ee = validateEmail(emailVal);
      const pe = validatePassword(passVal);
      if (ue) { showError('username', ue); return; }
      if (ee) { showError('email', ee); return; }
      if (pe) { showError('password', pe); return; }

      const taken = await (async () => {
        const q = query(collection(db,"users"), where("usernameLower","==",userVal.toLowerCase()));
        return !(await getDocs(q)).empty;
      })();
      if (taken) { showError('username', 'Username already taken'); return; }

      statusEl.textContent = 'Checking password security...'; statusEl.classList.add('typing');
      const breachCount = await checkPasswordBreach(passVal);
      if (breachCount > 0) {
        inputs.password.className = 'warning';
        passwordWarning.textContent = `âš  Password found in ${breachCount.toLocaleString()} breaches â€” choose another`;
        passwordWarning.classList.add('show');
        statusEl.textContent = '';
        return;
      }

      actionBtn.disabled = true;
      statusEl.textContent = 'Creating account...';
      isSigningUp = true;
      const deviceId = getDeviceId();
      const cred = await createUserWithEmailAndPassword(auth, emailVal, passVal);
      await updateProfile(cred.user, { displayName: userVal });
      await setDoc(doc(db, "users", cred.user.uid), {
        username: userVal, usernameLower: userVal.toLowerCase(), email: emailVal,
        createdAt: new Date(), best2048: 0, bestFlappy: 0,
        activeSessions: [deviceId], maxSessions: 2, currentGameSession: null, lastActivity: new Date()
      });
      isSigningUp = false;
      statusEl.className = 'status-msg success';
      statusEl.textContent = 'Account created! Launching...';
      window.location.href = "blog.html";
    }
  } catch (err) {
    console.error(err);
    isSigningUp = false;
    actionBtn.disabled = false;
    statusEl.classList.remove('typing');
    let msg = err.message;
    if (err.code === 'auth/email-already-in-use') { msg = 'Email already registered. Try logging in.'; showError('email','Already in use'); }
    else if (err.code === 'auth/invalid-email') { msg = 'Invalid email format'; showError('email','Invalid email'); }
    else if (err.code === 'auth/weak-password') { msg = 'Password too weak'; showError('password','Too weak'); }
    else if (['auth/user-not-found','auth/wrong-password','auth/invalid-credential'].includes(err.code)) msg = 'Invalid email or password';
    msg = msg.replace('Firebase: ','').replace(/\(auth\/.*\)\.?/,'').trim();
    statusEl.className = 'status-msg error';
    statusEl.textContent = msg;
  }
};

// â”€â”€ PARTICLES â”€â”€
(function spawnParticles() {
  for (let i = 0; i < 20; i++) {
    const p = document.createElement('div');
    p.className = 'particle';
    p.style.cssText = `
      left: ${Math.random()*100}vw;
      animation-duration: ${6 + Math.random()*10}s;
      animation-delay: ${Math.random()*10}s;
      opacity: ${0.3 + Math.random()*0.7};
      width: ${1 + Math.random()*2}px;
      height: ${1 + Math.random()*2}px;
    `;
    document.body.appendChild(p);
  }
})();

// â”€â”€ ANIMATED COUNTERS â”€â”€
function animateCounter(el, target, duration) {
  let start = null;
  const step = ts => {
    if (!start) start = ts;
    const progress = Math.min((ts - start) / duration, 1);
    const ease = 1 - Math.pow(1 - progress, 3);
    el.textContent = Math.floor(ease * target).toLocaleString();
    if (progress < 1) requestAnimationFrame(step);
  };
  requestAnimationFrame(step);
}
setTimeout(() => {
  animateCounter(document.getElementById('counter1'), 247, 2000);
  animateCounter(document.getElementById('counter2'), 18329, 2500);
  animateCounter(document.getElementById('counter3'), 5841, 2200);
}, 1000);
</script>
</body>
</html>

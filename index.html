<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>WebArcade</title>

<style>
/* 1. DEFINE VARIABLES (DEFAULT = DARK MODE) */
:root {
  --bg-base: #020617;
  --bg-gradient: radial-gradient(circle at top, #1e293b, #020617);
  --bg-card: rgba(15, 23, 42, 0.6);
  --grid-color: rgba(99, 102, 241, 0.15);
  
  --text-main: #f8fafc;
  --text-muted: #94a3b8;
  
  --accent: #6366f1;
  --accent-glow: rgba(99, 102, 241, 0.5);
  
  --input-bg: rgba(0, 0, 0, 0.3);
  --input-border: rgba(255, 255, 255, 0.1);
  
  --modal-bg: linear-gradient(160deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.98));
}

/* 2. LIGHT MODE OVERRIDES (AUTOMATIC) */
@media (prefers-color-scheme: light) {
  :root {
    --bg-base: #f8fafc;
    --bg-gradient: radial-gradient(circle at top, #e2e8f0, #f8fafc);
    --bg-card: rgba(255, 255, 255, 0.7);
    --grid-color: rgba(99, 102, 241, 0.08);
    
    --text-main: #0f172a;
    --text-muted: #475569;
    
    --accent: #4f46e5;
    --accent-glow: rgba(79, 70, 229, 0.25);
    
    --input-bg: rgba(255, 255, 255, 0.8);
    --input-border: #cbd5e1;
    
    --modal-bg: linear-gradient(160deg, #ffffff, #f1f5f9);
  }
}

* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: "Segoe UI", system-ui, sans-serif;
  background: var(--bg-base);
  color: var(--text-main);
  min-height: 100vh;
  overflow-x: hidden;
  position: relative;
  transition: background 0.3s, color 0.3s;
}

/* --- ANIMATED BACKGROUND --- */
.retro-bg {
  position: fixed;
  inset: 0;
  z-index: -1;
  background: 
    linear-gradient(transparent 0%, var(--bg-base) 100%),
    linear-gradient(0deg, transparent 24%, var(--grid-color) 25%, var(--grid-color) 26%, transparent 27%, transparent 74%, var(--grid-color) 75%, var(--grid-color) 76%, transparent 77%, transparent),
    linear-gradient(90deg, transparent 24%, var(--grid-color) 25%, var(--grid-color) 26%, transparent 27%, transparent 74%, var(--grid-color) 75%, var(--grid-color) 76%, transparent 77%, transparent);
  background-size: 50px 50px;
  transform: perspective(500px) rotateX(60deg) translateY(0) translateZ(-200px);
  animation: moveGrid 10s linear infinite;
  opacity: 1; 
  pointer-events: none;
}

@keyframes moveGrid {
  0% { transform: perspective(500px) rotateX(60deg) translateY(0) translateZ(-200px); }
  100% { transform: perspective(500px) rotateX(60deg) translateY(50px) translateZ(-200px); }
}

/* --- HEADER --- */
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 5%;
  backdrop-filter: blur(5px);
  position: sticky;
  top: 0;
  z-index: 5;
}

header h1 {
  margin: 0;
  font-size: clamp(1.5rem, 4vw, 2rem);
  background: linear-gradient(to right, var(--accent), #a5b4fc);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

header button {
  border: none;
  padding: 10px 24px;
  border-radius: 99px;
  background: linear-gradient(135deg, var(--accent), #818cf8);
  color: white;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 4px 15px var(--accent-glow);
  transition: transform 0.2s, box-shadow 0.2s;
}

header button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px var(--accent-glow);
}

/* --- HERO SECTION --- */
.hero {
  min-height: 80vh;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
  padding: 0 20px;
  animation: fadeIn 1s ease-out;
}

.hero h2 {
  font-size: clamp(2.5rem, 8vw, 5rem);
  margin: 0 0 10px 0;
  line-height: 1.1;
  animation: float 4s ease-in-out infinite;
}

.hero p {
  opacity: 0.8;
  max-width: 600px;
  font-size: clamp(1rem, 2.5vw, 1.25rem);
  margin-top: 15px;
  line-height: 1.6;
  color: var(--text-muted);
}

/* --- MODAL --- */
.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(8px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 50;
  padding: 20px;
}

.modal {
  position: relative;
  background: var(--modal-bg);
  border: 1px solid var(--input-border);
  border-radius: 24px;
  width: 100%;
  max-width: 400px;
  padding: 32px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.4);
  animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  max-height: 90vh;
  overflow-y: auto;
}

/* Close Btn */
.close-btn {
  position: absolute;
  top: 15px;
  right: 20px;
  font-size: 28px;
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  transition: color 0.2s;
}
.close-btn:hover { color: var(--accent); }

.modal h3 {
  margin: 0 0 24px 0;
  text-align: center;
  font-size: 1.8rem;
  color: var(--text-main);
}

/* Inputs */
input {
  width: 100%;
  padding: 14px 16px;
  border-radius: 12px;
  border: 2px solid var(--input-border);
  background: var(--input-bg);
  color: var(--text-main);
  margin-bottom: 16px;
  outline: none;
  font-size: 16px;
  transition: border-color 0.3s, background 0.3s;
}

input:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 4px var(--accent-glow);
}

input.valid { border-color: #22c55e; }
input.invalid { border-color: #ef4444; }

.error-msg {
  color: #ef4444;
  font-size: 12px;
  margin-top: -12px;
  margin-bottom: 10px;
  padding-left: 5px;
  display: none;
}

.error-msg.show { display: block; }

.hidden { display: none; }

/* Main Button */
.main-btn {
  width: 100%;
  padding: 14px;
  border: none;
  border-radius: 12px;
  background: linear-gradient(90deg, var(--accent), #818cf8);
  color: white;
  font-size: 1rem;
  font-weight: 700;
  cursor: pointer;
  margin-top: 10px;
  transition: transform 0.2s, filter 0.2s;
}

.main-btn:hover:not(:disabled) {
  filter: brightness(1.1);
  transform: scale(1.02);
}

.main-btn:active { transform: scale(0.98); }

.main-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Status & Switch */
.status {
  margin-top: 15px;
  text-align: center;
  font-size: 0.9rem;
  min-height: 1.5em;
}
.error { color: #ef4444; }
.success { color: #22c55e; }

.switch {
  margin-top: 20px;
  text-align: center;
  font-size: 0.9rem;
  color: var(--text-muted);
  cursor: pointer;
  user-select: none;
}
.switch span {
  color: var(--accent);
  text-decoration: underline;
  font-weight: 600;
}

/* --- ANIMATIONS --- */
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes popIn { 
  from { transform: scale(0.9) translateY(20px); opacity: 0; } 
  to { transform: scale(1) translateY(0); opacity: 1; } 
}
@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}
</style>
</head>

<body>

<div class="retro-bg"></div>

<header>
  <h1>WebArcade üéÆ</h1>
  <button onclick="openModal()">Login / Signup</button>
</header>

<div class="hero">
  <h2>Play.<br>Compete.<br>Relax.</h2>
  <p>Your personal retro arcade dashboard. Save your scores, beat your friends, and play instantly.<br><br>
  <small style="color: var(--text-muted);">‚ö†Ô∏è Login required to play.</small></p>
</div>

<div class="modal-backdrop" id="modal" onclick="closeModal(event)">
  <div class="modal">
    <button class="close-btn" onclick="closeModal()">√ó</button>

    <h3 id="modalTitle">Login</h3>

    <input id="username" type="text" placeholder="Username (3-20 chars)" class="hidden" autocomplete="off" maxlength="20">
    <div class="error-msg" id="usernameError"></div>
    
    <input id="email" type="email" placeholder="Email Address">
    <div class="error-msg" id="emailError"></div>
    
    <input id="password" type="password" placeholder="Password (6+ chars)">
    <div class="error-msg" id="passwordError"></div>

    <button class="main-btn" id="actionBtn">Continue</button>

    <div class="status" id="status"></div>

    <div class="switch" onclick="toggleMode()">
      <span id="switchText">New user? Create account</span>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import {
  getAuth,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  updateProfile
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import {
  getFirestore,
  doc,
  setDoc,
  collection,
  query,
  where,
  getDocs
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCzomf89xZhgcPsfYXKsYspCt-CiUVzjBA",
  authDomain: "webarcade-d4c3d.firebaseapp.com",
  projectId: "webarcade-d4c3d",
  storageBucket: "webarcade-d4c3d.firebasestorage.app",
  messagingSenderId: "918209461327",
  appId: "1:918209461327:web:bd9c1a2431f9b5c66ffe3a"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const modal = document.getElementById("modal");
const statusEl = document.getElementById("status");
const actionBtn = document.getElementById("actionBtn");
const titleEl = document.getElementById("modalTitle");
const switchText = document.getElementById("switchText");
const usernameInput = document.getElementById("username");

const inputs = {
  username: usernameInput,
  email: document.getElementById("email"),
  password: document.getElementById("password")
};

const errors = {
  username: document.getElementById("usernameError"),
  email: document.getElementById("emailError"),
  password: document.getElementById("passwordError")
};

let mode = "login";

// --- VALIDATION FUNCTIONS ---

function validateUsername(username) {
  if (!username || username.length < 3) {
    return "Username must be at least 3 characters";
  }
  if (username.length > 20) {
    return "Username must be less than 20 characters";
  }
  if (!/^[a-zA-Z0-9_]+$/.test(username)) {
    return "Username can only contain letters, numbers, and underscores";
  }
  return null;
}

function validateEmail(email) {
  if (!email) {
    return "Email is required";
  }
  
  const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailPattern.test(email)) {
    return "Please enter a valid email address";
  }
  
  // Block fake/temporary email domains
  const blockedDomains = [
    'test.com', 'fake.com', 'example.com', 'mail.com',
    'tempmail.com', '10minutemail.com', 'guerrillamail.com',
    'mailinator.com', 'throwaway.email', 'temp-mail.org',
    'fakeinbox.com', 'yopmail.com'
  ];
  
  const domain = email.split('@')[1]?.toLowerCase();
  if (blockedDomains.includes(domain)) {
    return "Please use a real email address, not temporary/fake emails";
  }
  
  // Block suspicious patterns
  const suspiciousPatterns = [
    /^test\d*@/i, /^fake\d*@/i, /^demo\d*@/i,
    /^admin@/i, /^sample@/i, /^user\d+@/i
  ];
  
  for (let pattern of suspiciousPatterns) {
    if (pattern.test(email)) {
      return "Please use a real email address";
    }
  }
  
  return null;
}

function validatePassword(password) {
  if (!password || password.length < 6) {
    return "Password must be at least 6 characters";
  }
  return null;
}

async function isUsernameTaken(username) {
  try {
    const usersRef = collection(db, "users");
    const q = query(usersRef, where("usernameLower", "==", username.toLowerCase()));
    const snapshot = await getDocs(q);
    return !snapshot.empty;
  } catch (error) {
    console.error("Error checking username:", error);
    return false;
  }
}

async function checkEmailExists(email) {
  const domain = email.split('@')[1];
  if (!domain) return false;
  
  try {
    const response = await fetch(`https://dns.google/resolve?name=${domain}&type=MX`);
    const data = await response.json();
    
    if (data.Answer && data.Answer.length > 0) {
      return true;
    }
    
    const aResponse = await fetch(`https://dns.google/resolve?name=${domain}&type=A`);
    const aData = await aResponse.json();
    
    return aData.Answer && aData.Answer.length > 0;
  } catch (error) {
    console.error("Email domain check failed:", error);
    return true; // Allow on network error
  }
}

// --- UI HELPERS ---

function showError(field, message) {
  inputs[field].classList.remove("valid");
  inputs[field].classList.add("invalid");
  errors[field].textContent = message;
  errors[field].classList.add("show");
}

function clearError(field) {
  inputs[field].classList.remove("invalid");
  inputs[field].classList.add("valid");
  errors[field].classList.remove("show");
}

function clearAllErrors() {
  Object.keys(inputs).forEach(field => {
    inputs[field].classList.remove("valid", "invalid");
    errors[field].classList.remove("show");
  });
}

// --- REAL-TIME VALIDATION (Only for signup mode) ---

let usernameTimeout, emailTimeout;

inputs.username.addEventListener("input", async (e) => {
  if (mode !== "signup") return;
  
  const username = e.target.value.trim();
  const error = validateUsername(username);
  
  if (error) {
    showError("username", error);
  } else {
    clearTimeout(usernameTimeout);
    usernameTimeout = setTimeout(async () => {
      const taken = await isUsernameTaken(username);
      if (taken) {
        showError("username", "Username already taken");
      } else {
        clearError("username");
      }
    }, 500);
  }
});

inputs.email.addEventListener("input", (e) => {
  if (mode !== "signup") return;
  
  const email = e.target.value.trim();
  const error = validateEmail(email);
  
  if (error) {
    showError("email", error);
  } else {
    clearError("email");
    
    clearTimeout(emailTimeout);
    emailTimeout = setTimeout(async () => {
      const exists = await checkEmailExists(email);
      if (!exists) {
        showError("email", "Email domain doesn't exist or can't receive emails");
      }
    }, 800);
  }
});

inputs.password.addEventListener("input", (e) => {
  if (mode !== "signup") return;
  
  const password = e.target.value;
  const error = validatePassword(password);
  
  if (error) {
    showError("password", error);
  } else {
    clearError("password");
  }
});

// --- MODAL CONTROLS ---

window.openModal = () => {
  modal.style.display = "flex";
  statusEl.textContent = "";
  inputs.email.value = "";
  inputs.password.value = "";
  inputs.username.value = "";
  clearAllErrors();
};

window.closeModal = (e) => {
  if (!e || e.target === modal || e.target.classList.contains('close-btn')) {
    modal.style.display = "none";
  }
};

window.toggleMode = () => {
  mode = mode === "login" ? "signup" : "login";
  
  titleEl.textContent = mode === "login" ? "Login" : "Join the Arcade";
  switchText.textContent = mode === "login" 
    ? "New user? Create account" 
    : "Already have an account? Login";
  
  actionBtn.textContent = mode === "login" ? "Login" : "Sign Up";

  if (mode === "signup") {
    usernameInput.classList.remove("hidden");
    errors.username.classList.remove("hidden");
  } else {
    usernameInput.classList.add("hidden");
    errors.username.classList.add("hidden");
  }
  
  clearAllErrors();
  statusEl.textContent = "";
};

// --- MAIN ACTION ---

actionBtn.onclick = async () => {
  const emailVal = inputs.email.value.trim();
  const passVal = inputs.password.value;
  const userVal = inputs.username.value.trim();

  clearAllErrors();
  statusEl.textContent = "";
  statusEl.className = "status";

  if (!emailVal || !passVal) {
    statusEl.textContent = "Please fill in all fields.";
    statusEl.classList.add("error");
    return;
  }

  try {
    if (mode === "login") {
      // LOGIN MODE - Simple validation
      statusEl.textContent = "Logging in...";
      await signInWithEmailAndPassword(auth, emailVal, passVal);
      statusEl.textContent = "Success! Entering Arcade...";
      statusEl.classList.add("success");
      setTimeout(() => { location.href = "blog.html"; }, 1000);
      
    } else {
      // SIGNUP MODE - Full validation
      const usernameError = validateUsername(userVal);
      const emailError = validateEmail(emailVal);
      const passwordError = validatePassword(passVal);

      if (usernameError) {
        showError("username", usernameError);
        return;
      }
      if (emailError) {
        showError("email", emailError);
        return;
      }
      if (passwordError) {
        showError("password", passwordError);
        return;
      }

      // Check username uniqueness
      const taken = await isUsernameTaken(userVal);
      if (taken) {
        showError("username", "Username already taken");
        return;
      }

      // Check email domain
      statusEl.textContent = "Verifying email...";
      const emailExists = await checkEmailExists(emailVal);
      if (!emailExists) {
        showError("email", "Email domain doesn't exist. Please use a real email.");
        statusEl.textContent = "";
        return;
      }

      // Create account
      actionBtn.disabled = true;
      statusEl.textContent = "Creating account...";
      
      const cred = await createUserWithEmailAndPassword(auth, emailVal, passVal);
      
      await updateProfile(cred.user, { displayName: userVal });
      
      await setDoc(doc(db, "users", cred.user.uid), {
        username: userVal,
        usernameLower: userVal.toLowerCase(),
        email: emailVal,
        createdAt: new Date(),
        best2048: 0,
        bestFlappy: 0
      });

      statusEl.textContent = "Success! Entering Arcade...";
      statusEl.classList.add("success");
      setTimeout(() => { location.href = "blog.html"; }, 1000);
    }

  } catch (err) {
    console.error(err);
    actionBtn.disabled = false;
    
    let msg = err.message;
    
    // Handle Firebase errors
    if (err.code === "auth/email-already-in-use") {
      msg = "This email is already registered. Try logging in instead.";
      showError("email", "Email already in use");
    } else if (err.code === "auth/invalid-email") {
      msg = "Invalid email format";
      showError("email", "Invalid email");
    } else if (err.code === "auth/weak-password") {
      msg = "Password is too weak";
      showError("password", "Password too weak");
    } else if (err.code === "auth/user-not-found" || err.code === "auth/wrong-password") {
      msg = "Invalid email or password";
    }
    
    if (msg.includes("Firebase:")) {
      msg = msg.replace("Firebase: ", "").replace(/\(auth\/.*\)\.?/, "");
    }
    
    statusEl.textContent = msg;
    statusEl.classList.add("error");
  }
};
</script>

</body>
</html>

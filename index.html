<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>WebArcade</title>

<style>
/* 1. DEFINE VARIABLES (DEFAULT = DARK MODE) */
:root {
  --bg-base: #020617;
  --bg-gradient: radial-gradient(circle at top, #1e293b, #020617);
  --bg-card: rgba(15, 23, 42, 0.6);
  --grid-color: rgba(99, 102, 241, 0.15);
  
  --text-main: #f8fafc;
  --text-muted: #94a3b8;
  
  --accent: #6366f1;
  --accent-glow: rgba(99, 102, 241, 0.5);
  
  --input-bg: rgba(0, 0, 0, 0.3);
  --input-border: rgba(255, 255, 255, 0.1);
  
  --modal-bg: linear-gradient(160deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.98));
}

/* 2. LIGHT MODE OVERRIDES (AUTOMATIC) */
@media (prefers-color-scheme: light) {
  :root {
    --bg-base: #f8fafc;
    --bg-gradient: radial-gradient(circle at top, #e2e8f0, #f8fafc);
    --bg-card: rgba(255, 255, 255, 0.7);
    --grid-color: rgba(99, 102, 241, 0.08);
    
    --text-main: #0f172a;
    --text-muted: #475569;
    
    --accent: #4f46e5;
    --accent-glow: rgba(79, 70, 229, 0.25);
    
    --input-bg: rgba(255, 255, 255, 0.8);
    --input-border: #cbd5e1;
    
    --modal-bg: linear-gradient(160deg, #ffffff, #f1f5f9);
  }
}

* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: "Segoe UI", system-ui, sans-serif;
  background: var(--bg-base);
  color: var(--text-main);
  min-height: 100vh;
  overflow-x: hidden;
  position: relative;
  transition: background 0.3s, color 0.3s;
}

/* --- ANIMATED BACKGROUND --- */
.retro-bg {
  position: fixed;
  inset: 0;
  z-index: -1;
  background: 
    linear-gradient(transparent 0%, var(--bg-base) 100%),
    linear-gradient(0deg, transparent 24%, var(--grid-color) 25%, var(--grid-color) 26%, transparent 27%, transparent 74%, var(--grid-color) 75%, var(--grid-color) 76%, transparent 77%, transparent),
    linear-gradient(90deg, transparent 24%, var(--grid-color) 25%, var(--grid-color) 26%, transparent 27%, transparent 74%, var(--grid-color) 75%, var(--grid-color) 76%, transparent 77%, transparent);
  background-size: 50px 50px;
  transform: perspective(500px) rotateX(60deg) translateY(0) translateZ(-200px);
  animation: moveGrid 10s linear infinite;
  opacity: 1; 
  pointer-events: none;
}

@keyframes moveGrid {
  0% { transform: perspective(500px) rotateX(60deg) translateY(0) translateZ(-200px); }
  100% { transform: perspective(500px) rotateX(60deg) translateY(50px) translateZ(-200px); }
}

/* --- HEADER --- */
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 5%;
  backdrop-filter: blur(5px);
  position: sticky;
  top: 0;
  z-index: 5;
}

header h1 {
  margin: 0;
  font-size: clamp(1.5rem, 4vw, 2rem);
  background: linear-gradient(to right, var(--accent), #a5b4fc);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

header .user-info {
  display: none;
  align-items: center;
  gap: 15px;
}

header .user-info.visible {
  display: flex;
}

header .username {
  font-weight: 600;
  color: var(--text-main);
}

header .session-badge {
  font-size: 11px;
  padding: 4px 8px;
  background: rgba(34, 197, 94, 0.2);
  color: #22c55e;
  border-radius: 12px;
  border: 1px solid rgba(34, 197, 94, 0.3);
}

header button {
  border: none;
  padding: 10px 24px;
  border-radius: 99px;
  background: linear-gradient(135deg, var(--accent), #818cf8);
  color: white;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 4px 15px var(--accent-glow);
  transition: transform 0.2s, box-shadow 0.2s;
}

header button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px var(--accent-glow);
}

header .logout-btn {
  background: linear-gradient(135deg, #ef4444, #f87171);
  box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
}

/* --- HERO SECTION --- */
.hero {
  min-height: 80vh;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
  padding: 0 20px;
  animation: fadeIn 1s ease-out;
}

.hero h2 {
  font-size: clamp(2.5rem, 8vw, 5rem);
  margin: 0 0 10px 0;
  line-height: 1.1;
  animation: float 4s ease-in-out infinite;
}

.hero p {
  opacity: 0.8;
  max-width: 600px;
  font-size: clamp(1rem, 2.5vw, 1.25rem);
  margin-top: 15px;
  line-height: 1.6;
  color: var(--text-muted);
}

/* --- MODAL --- */
.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(8px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 50;
  padding: 20px;
}

.modal {
  position: relative;
  background: var(--modal-bg);
  border: 1px solid var(--input-border);
  border-radius: 24px;
  width: 100%;
  max-width: 400px;
  padding: 32px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.4);
  animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  max-height: 90vh;
  overflow-y: auto;
}

/* Close Btn */
.close-btn {
  position: absolute;
  top: 15px;
  right: 20px;
  font-size: 28px;
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  transition: color 0.2s;
}
.close-btn:hover { color: var(--accent); }

.modal h3 {
  margin: 0 0 24px 0;
  text-align: center;
  font-size: 1.8rem;
  color: var(--text-main);
}

/* Inputs */
input {
  width: 100%;
  padding: 14px 16px;
  border-radius: 12px;
  border: 2px solid var(--input-border);
  background: var(--input-bg);
  color: var(--text-main);
  margin-bottom: 16px;
  outline: none;
  font-size: 16px;
  transition: border-color 0.3s, background 0.3s;
}

input:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 4px var(--accent-glow);
}

input.valid { border-color: #22c55e; }
input.invalid { border-color: #ef4444; }
input.warning { border-color: #f59e0b; }

.error-msg {
  color: #ef4444;
  font-size: 12px;
  margin-top: -12px;
  margin-bottom: 10px;
  padding-left: 5px;
  display: none;
}

.error-msg.show { display: block; }

.warning-msg {
  color: #f59e0b;
  font-size: 12px;
  margin-top: -12px;
  margin-bottom: 10px;
  padding-left: 5px;
  display: none;
}

.warning-msg.show { display: block; }

.password-strength {
  height: 4px;
  border-radius: 2px;
  margin-top: -12px;
  margin-bottom: 10px;
  background: rgba(255,255,255,0.1);
  overflow: hidden;
}

.password-strength-bar {
  height: 100%;
  width: 0%;
  transition: width 0.3s, background 0.3s;
}

.password-strength-bar.weak {
  width: 33%;
  background: #ef4444;
}

.password-strength-bar.medium {
  width: 66%;
  background: #f59e0b;
}

.password-strength-bar.strong {
  width: 100%;
  background: #22c55e;
}

.hidden { display: none; }

/* Main Button */
.main-btn {
  width: 100%;
  padding: 14px;
  border: none;
  border-radius: 12px;
  background: linear-gradient(90deg, var(--accent), #818cf8);
  color: white;
  font-size: 1rem;
  font-weight: 700;
  cursor: pointer;
  margin-top: 10px;
  transition: transform 0.2s, filter 0.2s;
}

.main-btn:hover:not(:disabled) {
  filter: brightness(1.1);
  transform: scale(1.02);
}

.main-btn:active { transform: scale(0.98); }

.main-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Status & Switch */
.status {
  margin-top: 15px;
  text-align: center;
  font-size: 0.9rem;
  min-height: 1.5em;
}
.error { color: #ef4444; }
.success { color: #22c55e; }

.switch {
  margin-top: 20px;
  text-align: center;
  font-size: 0.9rem;
  color: var(--text-muted);
  cursor: pointer;
  user-select: none;
}
.switch span {
  color: var(--accent);
  text-decoration: underline;
  font-weight: 600;
}

.info-text {
  font-size: 11px;
  color: #94a3b8;
  margin-top: -8px;
  margin-bottom: 12px;
  padding-left: 5px;
}

/* --- ANIMATIONS --- */
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes popIn { 
  from { transform: scale(0.9) translateY(20px); opacity: 0; } 
  to { transform: scale(1) translateY(0); opacity: 1; } 
}
@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}
</style>
</head>

<body>

<div class="retro-bg"></div>

<header>
  <h1>WebArcade üéÆ</h1>
  <div id="headerActions">
    <button onclick="openModal()" id="loginBtn">Login / Signup</button>
    <div class="user-info" id="userInfo">
      <span class="username" id="usernameDisplay"></span>
      <span class="session-badge" id="sessionBadge">‚óè Active</span>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </div>
</header>

<div class="hero">
  <h2>Play.<br>Compete.<br>Relax.</h2>
  <p id="welcomeText">Your personal retro arcade dashboard. Save your scores, beat your friends, and play instantly.<br><br>
  <small style="color: var(--text-muted);">‚ö†Ô∏è Login required to play.</small></p>
</div>

<div class="modal-backdrop" id="modal" onclick="closeModal(event)">
  <div class="modal">
    <button class="close-btn" onclick="closeModal()">√ó</button>

    <h3 id="modalTitle">Login</h3>

    <input id="username" type="text" placeholder="Username (3-20 chars)" class="hidden" autocomplete="off" maxlength="20">
    <div class="error-msg" id="usernameError"></div>
    
    <input id="email" type="email" placeholder="Email Address" autocomplete="email">
    <div class="error-msg" id="emailError"></div>
    
    <input id="password" type="password" placeholder="Password (8+ chars)" autocomplete="current-password">
    <div class="password-strength hidden" id="strengthContainer">
      <div class="password-strength-bar" id="strengthBar"></div>
    </div>
    <div class="error-msg" id="passwordError"></div>
    <div class="warning-msg" id="passwordWarning"></div>
    <div class="info-text hidden" id="breachInfo">We check passwords against known breaches</div>

    <button class="main-btn" id="actionBtn">Continue</button>

    <div class="status" id="status"></div>

    <div class="switch" onclick="toggleMode()">
      <span id="switchText">New user? Create account</span>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import {
  getAuth,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  updateProfile,
  onAuthStateChanged,
  signOut,
  setPersistence,
  browserLocalPersistence
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import {
  getFirestore,
  doc,
  setDoc,
  getDoc,
  updateDoc,
  collection,
  query,
  where,
  getDocs,
  arrayUnion,
  arrayRemove
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCzomf89xZhgcPsfYXKsYspCt-CiUVzjBA",
  authDomain: "webarcade-d4c3d.firebaseapp.com",
  projectId: "webarcade-d4c3d",
  storageBucket: "webarcade-d4c3d.firebasestorage.app",
  messagingSenderId: "918209461327",
  appId: "1:918209461327:web:bd9c1a2431f9b5c66ffe3a"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// CRITICAL: Set persistence to LOCAL (survives browser close)
setPersistence(auth, browserLocalPersistence);

// --- GLOBAL STATE ---
let currentUser = null;
let currentDeviceId = null;

// --- DEVICE ID GENERATION ---
function getDeviceId() {
  let deviceId = localStorage.getItem('deviceId');
  if (!deviceId) {
    deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substring(2, 15);
    localStorage.setItem('deviceId', deviceId);
  }
  return deviceId;
}

// --- SESSION MANAGEMENT ---
async function registerSession(userId, deviceId) {
  try {
    const userDocRef = doc(db, "users", userId);
    const userDoc = await getDoc(userDocRef);
    
    if (userDoc.exists()) {
      const userData = userDoc.data();
      const activeSessions = userData.activeSessions || [];
      const maxSessions = userData.maxSessions || 2;
      
      // Check if device already registered
      if (!activeSessions.includes(deviceId)) {
        // Check session limit
        if (activeSessions.length >= maxSessions) {
          throw new Error(`Session limit reached. Maximum ${maxSessions} devices allowed. Please logout from another device first.`);
        }
        
        // Add new session
        await updateDoc(userDocRef, {
          activeSessions: arrayUnion(deviceId),
          lastActivity: new Date()
        });
      } else {
        // Update last activity
        await updateDoc(userDocRef, {
          lastActivity: new Date()
        });
      }
    }
  } catch (error) {
    console.error("Session registration error:", error);
    throw error;
  }
}

async function unregisterSession(userId, deviceId) {
  try {
    const userDocRef = doc(db, "users", userId);
    await updateDoc(userDocRef, {
      activeSessions: arrayRemove(deviceId),
      currentGameSession: null // Clear any active game session
    });
  } catch (error) {
    console.error("Session unregister error:", error);
  }
}

// --- PASSWORD BREACH CHECK ---
async function checkPasswordBreach(password) {
  try {
    const encoder = new TextEncoder();
    const data = encoder.encode(password);
    const hashBuffer = await crypto.subtle.digest('SHA-1', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('').toUpperCase();
    
    const prefix = hashHex.substring(0, 5);
    const suffix = hashHex.substring(5);
    
    const response = await fetch(`https://api.pwnedpasswords.com/range/${prefix}`);
    const text = await response.text();
    
    const lines = text.split('\n');
    for (let line of lines) {
      const [hashSuffix, count] = line.split(':');
      if (hashSuffix === suffix) {
        return parseInt(count);
      }
    }
    
    return 0;
  } catch (error) {
    console.error("Breach check failed:", error);
    return 0;
  }
}

// --- AUTHENTICATION STATE LISTENER ---
onAuthStateChanged(auth, async (user) => {
  const loginBtn = document.getElementById('loginBtn');
  const userInfo = document.getElementById('userInfo');
  const usernameDisplay = document.getElementById('usernameDisplay');
  const welcomeText = document.getElementById('welcomeText');
  
  if (user) {
    try {
      currentUser = user;
      currentDeviceId = getDeviceId();
      
      // Register this session
      await registerSession(user.uid, currentDeviceId);
      
      // Update UI
      loginBtn.style.display = 'none';
      userInfo.classList.add('visible');
      
      // Get username from Firestore
      const userDoc = await getDoc(doc(db, "users", user.uid));
      if (userDoc.exists()) {
        const username = userDoc.data().username;
        usernameDisplay.textContent = username;
      } else {
        usernameDisplay.textContent = user.displayName || 'Player';
      }

      // Redirect to blog page after successful auth
      window.location.href = "blog.html";
      
    } catch (error) {
      console.error("Session error:", error);
      if (error.message.includes("Session limit")) {
        alert(error.message);
        await signOut(auth);
      }
    }
  } else {
    // User logged out
    currentUser = null;
    loginBtn.style.display = 'block';
    userInfo.classList.remove('visible');
    welcomeText.innerHTML = `Your personal retro arcade dashboard. Save your scores, beat your friends, and play instantly.<br><br>
    <small style="color: var(--text-muted);">‚ö†Ô∏è Login required to play.</small>`;
  }
});

// --- LOGOUT ---
window.logout = async function() {
  if (currentUser && currentDeviceId) {
    await unregisterSession(currentUser.uid, currentDeviceId);
  }
  await signOut(auth);
  location.reload();
};

// --- UI ELEMENTS ---
const modal = document.getElementById("modal");
const statusEl = document.getElementById("status");
const actionBtn = document.getElementById("actionBtn");
const titleEl = document.getElementById("modalTitle");
const switchText = document.getElementById("switchText");
const usernameInput = document.getElementById("username");
const strengthContainer = document.getElementById("strengthContainer");
const strengthBar = document.getElementById("strengthBar");
const breachInfo = document.getElementById("breachInfo");

const inputs = {
  username: usernameInput,
  email: document.getElementById("email"),
  password: document.getElementById("password")
};

const errors = {
  username: document.getElementById("usernameError"),
  email: document.getElementById("emailError"),
  password: document.getElementById("passwordError")
};

const passwordWarning = document.getElementById("passwordWarning");

let mode = "login";

// --- VALIDATION FUNCTIONS ---

function validateUsername(username) {
  if (!username || username.length < 3) {
    return "Username must be at least 3 characters";
  }
  if (username.length > 20) {
    return "Username must be less than 20 characters";
  }
  if (!/^[a-zA-Z0-9_]+$/.test(username)) {
    return "Username can only contain letters, numbers, and underscores";
  }
  return null;
}

function validateEmail(email) {
  if (!email) {
    return "Email is required";
  }
  
  const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailPattern.test(email)) {
    return "Please enter a valid email address";
  }
  
  const blockedDomains = [
    'test.com', 'fake.com', 'example.com', 'mail.com',
    'tempmail.com', '10minutemail.com', 'guerrillamail.com',
    'mailinator.com', 'throwaway.email', 'temp-mail.org',
    'fakeinbox.com', 'yopmail.com'
  ];
  
  const domain = email.split('@')[1]?.toLowerCase();
  if (blockedDomains.includes(domain)) {
    return "Please use a real email address, not temporary/fake emails";
  }
  
  const suspiciousPatterns = [
    /^test\d*@/i, /^fake\d*@/i, /^demo\d*@/i,
    /^admin@/i, /^sample@/i, /^user\d+@/i
  ];
  
  for (let pattern of suspiciousPatterns) {
    if (pattern.test(email)) {
      return "Please use a real email address";
    }
  }
  
  return null;
}

function calculatePasswordStrength(password) {
  let strength = 0;
  
  if (password.length >= 8) strength++;
  if (password.length >= 12) strength++;
  if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
  if (/\d/.test(password)) strength++;
  if (/[^a-zA-Z0-9]/.test(password)) strength++;
  
  return strength;
}

function validatePassword(password) {
  if (!password || password.length < 8) {
    return "Password must be at least 8 characters";
  }
  if (!/[a-zA-Z]/.test(password)) {
    return "Password must contain letters";
  }
  if (!/\d/.test(password)) {
    return "Password must contain at least one number";
  }
  return null;
}

async function isUsernameTaken(username) {
  try {
    const usersRef = collection(db, "users");
    const q = query(usersRef, where("usernameLower", "==", username.toLowerCase()));
    const snapshot = await getDocs(q);
    return !snapshot.empty;
  } catch (error) {
    console.error("Error checking username:", error);
    return false;
  }
}

async function checkEmailExists(email) {
  const domain = email.split('@')[1];
  if (!domain) return false;
  
  try {
    const response = await fetch(`https://dns.google/resolve?name=${domain}&type=MX`);
    const data = await response.json();
    
    if (data.Answer && data.Answer.length > 0) {
      return true;
    }
    
    const aResponse = await fetch(`https://dns.google/resolve?name=${domain}&type=A`);
    const aData = await aResponse.json();
    
    return aData.Answer && aData.Answer.length > 0;
  } catch (error) {
    console.error("Email domain check failed:", error);
    return true;
  }
}

// --- UI HELPERS ---

function showError(field, message) {
  inputs[field].classList.remove("valid", "warning");
  inputs[field].classList.add("invalid");
  errors[field].textContent = message;
  errors[field].classList.add("show");
}

function showWarning(field, message) {
  inputs[field].classList.remove("valid", "invalid");
  inputs[field].classList.add("warning");
  if (field === "password") {
    passwordWarning.textContent = message;
    passwordWarning.classList.add("show");
  }
}

function clearError(field) {
  inputs[field].classList.remove("invalid", "warning");
  inputs[field].classList.add("valid");
  errors[field].classList.remove("show");
  if (field === "password") {
    passwordWarning.classList.remove("show");
  }
}

function clearAllErrors() {
  Object.keys(inputs).forEach(field => {
    inputs[field].classList.remove("valid", "invalid", "warning");
    errors[field].classList.remove("show");
  });
  passwordWarning.classList.remove("show");
}

// --- REAL-TIME VALIDATION (Only for signup mode) ---

let usernameTimeout, emailTimeout, passwordTimeout;
let lastPasswordBreachCheck = "";

inputs.username.addEventListener("input", async (e) => {
  if (mode !== "signup") return;
  
  const username = e.target.value.trim();
  const error = validateUsername(username);
  
  if (error) {
    showError("username", error);
  } else {
    clearTimeout(usernameTimeout);
    usernameTimeout = setTimeout(async () => {
      const taken = await isUsernameTaken(username);
      if (taken) {
        showError("username", "Username already taken");
      } else {
        clearError("username");
      }
    }, 500);
  }
});

inputs.email.addEventListener("input", (e) => {
  if (mode !== "signup") return;
  
  const email = e.target.value.trim();
  const error = validateEmail(email);
  
  if (error) {
    showError("email", error);
  } else {
    clearError("email");
    
    clearTimeout(emailTimeout);
    emailTimeout = setTimeout(async () => {
      const exists = await checkEmailExists(email);
      if (!exists) {
        showError("email", "Email domain doesn't exist or can't receive emails");
      }
    }, 800);
  }
});

inputs.password.addEventListener("input", async (e) => {
  if (mode !== "signup") return;
  
  const password = e.target.value;
  const error = validatePassword(password);
  
  // Update strength bar
  const strength = calculatePasswordStrength(password);
  strengthBar.className = "password-strength-bar";
  if (strength >= 4) {
    strengthBar.classList.add("strong");
  } else if (strength >= 2) {
    strengthBar.classList.add("medium");
  } else if (password.length > 0) {
    strengthBar.classList.add("weak");
  }
  
  if (error) {
    showError("password", error);
    passwordWarning.classList.remove("show");
  } else {
    clearError("password");
    
    // Check for breaches (debounced)
    clearTimeout(passwordTimeout);
    passwordTimeout = setTimeout(async () => {
      if (password === lastPasswordBreachCheck) return;
      lastPasswordBreachCheck = password;
      
      const breachCount = await checkPasswordBreach(password);
      if (breachCount > 0) {
        showWarning("password", `‚ö†Ô∏è This password has been found in ${breachCount.toLocaleString()} data breaches. Choose a different one.`);
      } else {
        passwordWarning.classList.remove("show");
      }
    }, 1000);
  }
});

// --- MODAL CONTROLS ---

window.openModal = () => {
  modal.style.display = "flex";
  statusEl.textContent = "";
  inputs.email.value = "";
  inputs.password.value = "";
  inputs.username.value = "";
  clearAllErrors();
};

window.closeModal = (e) => {
  if (!e || e.target === modal || e.target.classList.contains('close-btn')) {
    modal.style.display = "none";
  }
};

window.toggleMode = () => {
  mode = mode === "login" ? "signup" : "login";
  
  titleEl.textContent = mode === "login" ? "Login" : "Join the Arcade";
  switchText.textContent = mode === "login" 
    ? "New user? Create account" 
    : "Already have an account? Login";
  
  actionBtn.textContent = mode === "login" ? "Login" : "Sign Up";

  if (mode === "signup") {
    usernameInput.classList.remove("hidden");
    errors.username.classList.remove("hidden");
    strengthContainer.classList.remove("hidden");
    breachInfo.classList.remove("hidden");
    inputs.password.setAttribute("autocomplete", "new-password");
  } else {
    usernameInput.classList.add("hidden");
    errors.username.classList.add("hidden");
    strengthContainer.classList.add("hidden");
    breachInfo.classList.add("hidden");
    passwordWarning.classList.remove("show");
    inputs.password.setAttribute("autocomplete", "current-password");
  }
  
  clearAllErrors();
  statusEl.textContent = "";
};

// --- MAIN ACTION ---

actionBtn.onclick = async () => {
  const emailVal = inputs.email.value.trim();
  const passVal = inputs.password.value;
  const userVal = inputs.username.value.trim();

  clearAllErrors();
  statusEl.textContent = "";
  statusEl.className = "status";

  if (!emailVal || !passVal) {
    statusEl.textContent = "Please fill in all fields.";
    statusEl.classList.add("error");
    return;
  }

  try {
    if (mode === "login") {
      // LOGIN MODE
      statusEl.textContent = "Logging in...";
      actionBtn.disabled = true;
      
      const deviceId = getDeviceId();
      const cred = await signInWithEmailAndPassword(auth, emailVal, passVal);
      
      // Register session (will check limits)
      await registerSession(cred.user.uid, deviceId);
      
      statusEl.textContent = "Success! Redirecting...";
      statusEl.classList.add("success");
      
      // Redirect handled by onAuthStateChanged
      
    } else {
      // SIGNUP MODE
      const usernameError = validateUsername(userVal);
      const emailError = validateEmail(emailVal);
      const passwordError = validatePassword(passVal);

      if (usernameError) {
        showError("username", usernameError);
        return;
      }
      if (emailError) {
        showError("email", emailError);
        return;
      }
      if (passwordError) {
        showError("password", passwordError);
        return;
      }

      // Check username uniqueness
      const taken = await isUsernameTaken(userVal);
      if (taken) {
        showError("username", "Username already taken");
        return;
      }

      // Check email domain
      statusEl.textContent = "Verifying email...";
      const emailExists = await checkEmailExists(emailVal);
      if (!emailExists) {
        showError("email", "Email domain doesn't exist. Please use a real email.");
        statusEl.textContent = "";
        return;
      }

      // CRITICAL: Check password breach
      statusEl.textContent = "Checking password security...";
      const breachCount = await checkPasswordBreach(passVal);
      if (breachCount > 0) {
        showWarning("password", `‚ö†Ô∏è This password has been found in ${breachCount.toLocaleString()} data breaches. Choose a different one.`);
        statusEl.textContent = "";
        alert(`Security Warning: This password has appeared in ${breachCount.toLocaleString()} data breaches. Please choose a more secure password.`);
        return;
      }

      // Create account
      actionBtn.disabled = true;
      statusEl.textContent = "Creating account...";
      
      const deviceId = getDeviceId();
      const cred = await createUserWithEmailAndPassword(auth, emailVal, passVal);
      
      await updateProfile(cred.user, { displayName: userVal });
      
      await setDoc(doc(db, "users", cred.user.uid), {
        username: userVal,
        usernameLower: userVal.toLowerCase(),
        email: emailVal,
        createdAt: new Date(),
        best2048: 0,
        bestFlappy: 0,
        // Session management
        activeSessions: [deviceId],
        maxSessions: 2,
        currentGameSession: null,
        lastActivity: new Date()
      });

      statusEl.textContent = "Success! Redirecting...";
      statusEl.classList.add("success");
      
      // Redirect handled by onAuthStateChanged
    }

  } catch (err) {
    console.error(err);
    actionBtn.disabled = false;
    
    let msg = err.message;
    
    if (err.code === "auth/email-already-in-use") {
      msg = "This email is already registered. Try logging in instead.";
      showError("email", "Email already in use");
    } else if (err.code === "auth/invalid-email") {
      msg = "Invalid email format";
      showError("email", "Invalid email");
    } else if (err.code === "auth/weak-password") {
      msg = "Password is too weak";
      showError("password", "Password too weak");
    } else if (err.code === "auth/user-not-found" || err.code === "auth/wrong-password" || err.code === "auth/invalid-credential") {
      msg = "Invalid email or password";
    } else if (msg.includes("Session limit")) {
      // Custom session limit error
      msg = err.message;
    }
    
    if (msg.includes("Firebase:")) {
      msg = msg.replace("Firebase: ", "").replace(/\(auth\/.*\)\.?/, "");
    }
    
    statusEl.textContent = msg;
    statusEl.classList.add("error");
  }
};
</script>

</body>
</html>
